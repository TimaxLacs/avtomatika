# Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Avtomatika Ğ½Ğ° macOS

## ğŸ“‹ ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ²ĞµÑ€Ğ´Ğ¸ĞºÑ‚

âœ… **Ğ”Ğ°, Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° macOS Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼.**

ĞŸÑ€Ğ¾ĞµĞºÑ‚ ÑĞ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ±ĞµĞ· Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹.

---

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### Ğ—Ğ°Ğ¼ĞµĞ½Ğ° Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ½Ğ° Ğ¼Ğ¾ĞºĞ¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRODUCTION                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Redis Server  â”‚  PostgreSQL  â”‚  Real Workers  â”‚  OpenTelemetry â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚              â”‚                â”‚
         â”‚    Ğ¢Ğ•Ğ¡Ğ¢Ğ« Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ®Ğ¢ ĞœĞĞšĞ˜    â”‚                â”‚
         â”‚               â”‚              â”‚                â”‚
         â–¼               â–¼              â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   fakeredis    â”‚  NoOpHistory  â”‚  AsyncMock  â”‚  ConsoleExporterâ”‚
â”‚   (in-memory)  â”‚  Storage      â”‚  Workers    â”‚  (stdout)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ§Ñ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ² Ñ‚ĞµÑÑ‚Ğ°Ñ…

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | Production | Ğ¢ĞµÑÑ‚Ñ‹ |
|-----------|------------|-------|
| **State Storage** | Redis | `fakeredis` (in-memory Redis mock) |
| **History Storage** | PostgreSQL/SQLite | `NoOpHistoryStorage` (Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°) |
| **Workers** | Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñ‹ | `AsyncMock` / Inline handlers |
| **Tracing** | Jaeger/Zipkin | `ConsoleSpanExporter` (Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ² stdout) |
| **HTTP Client** | aiohttp | `pytest-aiohttp` test client |

---

## Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹

```bash
# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²ÑĞµÑ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ
pip install -e ".[all,test]"

# Ğ˜Ğ»Ğ¸ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ±ĞµĞ· Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ñ…
pip install -e ".[test]"
```

### Ğ§Ñ‚Ğ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ (Ğ¸Ğ· `pyproject.toml`)

```toml
[project.optional-dependencies]
test = [
    "pytest~=9.0",
    "pytest-asyncio~=1.1",
    "fakeredis~=2.33",          # â† In-memory Redis mock
    "pytest-aiohttp~=1.1",      # â† aiohttp test client
    "pytest-mock~=3.14",        # â† Mocking utilities
    "aioresponses~=0.7",        # â† HTTP response mocking
    "backports.zstd~=1.2",      # â† Compression testing
    "opentelemetry-instrumentation-aiohttp-client",
]
```

### Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸

Ğ•Ğ´Ğ¸Ğ½ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ°Ñ **Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ** ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ â€” **Graphviz** (Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ blueprints):

```bash
# macOS (Homebrew)
brew install graphviz

# Ğ‘ĞµĞ· Ğ½ĞµĞ³Ğ¾ Ñ‚ĞµÑÑ‚Ñ‹ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ñ‹, Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚
```

---

## Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ‚ĞµÑÑ‚Ğ¾Ğ²

### ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹

```bash
# Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹
pytest tests/

# Ğ¡ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¼ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¾Ğ¼
pytest tests/ -v

# ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»
pytest tests/test_dispatcher.py

# ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ñ‚ĞµÑÑ‚
pytest tests/test_integration.py::test_sub_blueprint_flow -v

# ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ (Ñ pytest-xdist)
pytest tests/ -n auto

# Ğ¡ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼ ĞºĞ¾Ğ´Ğ°
pytest tests/ --cov=src/avtomatika --cov-report=html
```

### ĞœĞ°Ñ€ĞºĞµÑ€Ñ‹ Ñ‚ĞµÑÑ‚Ğ¾Ğ²

```bash
# ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ e2e Ñ‚ĞµÑÑ‚Ñ‹ (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ)
pytest tests/ -m "not e2e"

# Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ async Ñ‚ĞµÑÑ‚Ñ‹
pytest tests/ -m asyncio
```

---

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²

### ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

```
tests/
â”œâ”€â”€ conftest.py                    # Fixtures Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²
â”œâ”€â”€ clients.toml                   # Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸
â”œâ”€â”€ workers.toml                   # Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²
â”œâ”€â”€ storage_test_suite.py          # Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ test suite Ğ´Ğ»Ñ storage
â”‚
â”œâ”€â”€ test_blueprint_conditions.py   # Ğ£ÑĞ»Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñ‹ Ğ² blueprints
â”œâ”€â”€ test_blueprints.py             # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ blueprints
â”œâ”€â”€ test_client_config_loader.py   # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¸Ñ… ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ²
â”œâ”€â”€ test_compression.py            # Ğ¡Ğ¶Ğ°Ñ‚Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² (gzip, zstd)
â”œâ”€â”€ test_config_validation.py      # Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
â”œâ”€â”€ test_context.py                # ActionFactory Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
â”œâ”€â”€ test_dispatcher.py             # Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡
â”œâ”€â”€ test_dispatcher_extended.py    # Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ´Ğ¸ÑĞ¿ĞµÑ‚Ñ‡ĞµÑ€Ğ°
â”œâ”€â”€ test_engine.py                 # OrchestratorEngine
â”œâ”€â”€ test_error_handling.py         # ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
â”œâ”€â”€ test_executor.py               # JobExecutor
â”œâ”€â”€ test_health_checker.py         # HealthChecker
â”œâ”€â”€ test_history.py                # History storage
â”œâ”€â”€ test_integration.py            # Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹
â”œâ”€â”€ test_logging_config.py         # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
â”œâ”€â”€ test_memory_locking.py         # Distributed locks (memory)
â”œâ”€â”€ test_memory_storage.py         # MemoryStorage
â”œâ”€â”€ test_metrics.py                # Prometheus Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
â”œâ”€â”€ test_noop_history.py           # NoOp history storage
â”œâ”€â”€ test_postgres_history.py       # PostgreSQL history (Ñ skip)
â”œâ”€â”€ test_ratelimit.py              # Rate limiting
â”œâ”€â”€ test_redis_locking.py          # Distributed locks (redis)
â”œâ”€â”€ test_redis_storage.py          # RedisStorage (fakeredis)
â”œâ”€â”€ test_reputation.py             # Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ñ€ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¸
â”œâ”€â”€ test_telemetry.py              # OpenTelemetry
â”œâ”€â”€ test_watcher.py                # Watcher (Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ñ‹)
â”œâ”€â”€ test_worker_config_loader.py   # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²
â””â”€â”€ test_ws_manager.py             # WebSocket manager
```

---

## ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ fixtures

### `conftest.py` â€” Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğµ fixtures

```python
# 1. Fakeredis ĞºĞ»Ğ¸ĞµĞ½Ñ‚ (Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°)
@pytest_asyncio.fixture
async def redis_client():
    client = redis.FakeRedis(decode_responses=False)
    yield client
    await client.aclose()

# 2. MemoryStorage (Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²)
@pytest.fixture
def memory_storage():
    return MemoryStorage()

# 3. RedisStorage Ñ fakeredis
@pytest.fixture
def redis_storage(redis_client):
    return RedisStorage(redis_client)

# 4. ĞŸĞ¾Ğ»Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ aiohttp (Ğ´Ğ»Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²)
@pytest_asyncio.fixture
async def app(request, config, redis_storage):
    engine = OrchestratorEngine(storage, config)
    # ... Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° blueprints ...
    yield engine.app
    await engine.on_shutdown(engine.app)

# 5. OpenTelemetry Ñ ConsoleExporter
@pytest.fixture(scope="session", autouse=True)
def tracing_setup():
    provider = TracerProvider()
    processor = SimpleSpanProcessor(ConsoleSpanExporter(out=sys.stdout))
    provider.add_span_processor(processor)
    trace.set_tracer_provider(provider)
```

---

## Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±ĞµĞ· Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²

### 1. Redis â†’ fakeredis

```python
# ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ in-memory, Ğ±ĞµĞ· Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Redis
from fakeredis import aioredis as redis

client = redis.FakeRedis(decode_responses=False)

# ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğ½ÑÑ‚Ğ²Ğ¾ Redis-ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´:
# - GET, SET, DEL, EXPIRE
# - LPUSH, BRPOP, LLEN
# - ZADD, ZRANGEBYSCORE, ZREM
# - HSET, HGETALL
# - Ğ˜ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ...

# ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ fakeredis (Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ñ‹ Ğ² ĞºĞ¾Ğ´Ğµ):
# - BZPOPMAX Ğ¸Ğ¼ĞµĞµÑ‚ fallback Ğ½Ğ° ZPOPMAX
# - Lua-ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹ Ğ¸Ğ¼ĞµÑÑ‚ fallback Ğ½Ğ° GET/DECR
```

### 2. PostgreSQL â†’ NoOpHistoryStorage Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞº

```python
# NoOpHistoryStorage â€” Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°, Ğ½Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾
class NoOpHistoryStorage(HistoryStorageBase):
    async def log_job_event(self, event_data): pass
    async def log_worker_event(self, event_data): pass
    async def get_job_history(self, job_id): return []
    # ...

# PostgreSQL Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ÑÑ‚ÑÑ Ğ±ĞµĞ· Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ‘Ğ”
@pytest.mark.skipif(
    not postgres_available,
    reason="PostgreSQL not available"
)
async def test_postgres_history():
    ...
```

### 3. Workers â†’ AsyncMock

```python
from unittest.mock import AsyncMock

# ĞœĞ¾Ğº Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°
mock_worker = {
    "worker_id": "test-worker",
    "supported_tasks": ["test_task"],
    "status": "idle",
}

# ĞœĞ¾Ğº storage
mock_storage = MagicMock()
mock_storage.get_available_workers = AsyncMock(return_value=[mock_worker])
mock_storage.enqueue_task_for_worker = AsyncMock()
```

### 4. HTTP Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ â†’ pytest-aiohttp

```python
@pytest.mark.asyncio
async def test_create_job(aiohttp_client, app):
    client = await aiohttp_client(app)
    
    resp = await client.post(
        "/api/v1/jobs/my_flow",
        json={"input": "data"},
        headers={"X-Avtomatika-Token": "token"}
    )
    assert resp.status == 202
```

---

## ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµÑÑ‚Ğ°

```python
# tests/test_integration.py

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ blueprint Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ² Ñ‚ĞµÑÑ‚Ğµ
parent_bp = StateMachineBlueprint(
    name="parent_flow",
    api_endpoint="/jobs/parent_flow",
    api_version="v1"
)

@parent_bp.handler_for("start", is_start=True)
async def parent_start(context, actions):
    actions.transition_to("finished")

@parent_bp.handler_for("finished", is_end=True)
async def parent_finished(context, actions):
    pass

# ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¸Ğ·ÑƒĞµĞ¼ fixture Ğ´Ğ»Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ blueprints
@pytest.mark.parametrize(
    "app",
    [{"extra_blueprints": [parent_bp]}],
    indirect=True,
)
@pytest.mark.asyncio
async def test_job_flow(aiohttp_client, app):
    client = await aiohttp_client(app)
    storage = app[STORAGE_KEY]
    
    # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ²Ğ¾Ñ‚Ñƒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
    await storage.initialize_client_quota("user_token_vip", 5)
    
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ job
    headers = {"X-Avtomatika-Token": "user_token_vip"}
    resp = await client.post("/api/v1/jobs/parent_flow", json={}, headers=headers)
    assert resp.status == 202
    job_id = (await resp.json())["job_id"]
    
    # Ğ–Ğ´Ñ‘Ğ¼ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ (polling)
    for _ in range(10):
        await asyncio.sleep(0.1)
        state = await storage.get_job_state(job_id)
        if state.get("current_state") == "finished":
            break
    
    assert state["current_state"] == "finished"
```

---

## ĞŸĞ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ğ½Ğ° macOS

### 1. âŒ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: `graphviz` Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½

```
FileNotFoundError: [Errno 2] No such file or directory: 'dot'
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```bash
brew install graphviz
```

### 2. âŒ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: fakeredis Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ½ĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹

```
ResponseError: unknown command `BZPOPMAX`
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Ğ£Ğ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ Ğ² ĞºĞ¾Ğ´Ğµ â€” ĞµÑÑ‚ÑŒ fallback:
```python
# Ğ’ RedisStorage.dequeue_task_for_worker()
except ResponseError as e:
    if "unknown command" in str(e).lower():
        # Non-blocking fallback for tests
        res = await self._redis.zpopmax(key)
```

### 3. âŒ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞŸĞ¾Ñ€Ñ‚ Ğ·Ğ°Ğ½ÑÑ‚

```
OSError: [Errno 48] Address already in use
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Ğ¢ĞµÑÑ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ñ‡ĞµÑ€ĞµĞ· aiohttp test client.

### 4. âŒ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğµ async Ñ‚ĞµÑÑ‚Ñ‹

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
```bash
# ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ
pip install pytest-xdist
pytest tests/ -n auto
```

---

## Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Worker SDK

Worker SDK (`avtomatika_worker`) Ñ‚Ğ°ĞºĞ¶Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾:

```bash
cd avtomatika_worker
pip install -e ".[test]"
pytest tests/
```

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ñ‚ĞµÑÑ‚Ğ° Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°

```python
from avtomatika_worker import Worker
from unittest.mock import AsyncMock
import aiohttp

@pytest.mark.asyncio
async def test_worker_task_registration():
    worker = Worker(worker_type="test-worker")
    
    @worker.task("my_task")
    async def my_handler(params, **kwargs):
        return {"status": "success", "data": {"result": params["x"] * 2}}
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
    assert "my_task" in worker._task_handlers
    
    # ĞœĞ¾ĞºĞ°ĞµĞ¼ HTTP ÑĞµÑÑĞ¸Ñ
    worker._http_session = AsyncMock(spec=aiohttp.ClientSession)
    
    # Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
    result = await worker._task_handlers["my_task"]["func"](
        {"x": 5}, task_id="t1", job_id="j1"
    )
    assert result["status"] == "success"
    assert result["data"]["result"] == 10
```

---

## Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ checklist

| Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ | ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ |
|------------|--------|-------------|
| Python 3.11+ | âœ… | `brew install python@3.11` |
| pip/venv | âœ… | Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾ Ğ² Python |
| Redis | âœ… | ĞĞµ Ğ½ÑƒĞ¶ĞµĞ½ â€” fakeredis |
| PostgreSQL | âœ… | ĞĞµ Ğ½ÑƒĞ¶ĞµĞ½ â€” NoOpHistoryStorage |
| Graphviz | âš ï¸ | ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ |
| pytest | âœ… | Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· `[test]` |

## ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‚Ğ°

```bash
# 1. ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼
cd /Users/timax/projects/avtomatika

# 2. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ
python3.11 -m venv .venv
source .venv/bin/activate

# 3. Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑĞ¼Ğ¸
pip install -e ".[all,test]"

# 4. ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Graphviz
brew install graphviz

# 5. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ñ‹
pytest tests/ -v

# 6. Ğ¡ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸ĞµĞ¼
pytest tests/ --cov=src/avtomatika --cov-report=term-missing
```

---

## Ğ—Ğ°ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ

ĞŸÑ€Ğ¾ĞµĞºÑ‚ **Avtomatika** Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ½ÑƒÑ Ñ‚ĞµÑÑ‚Ğ¾Ğ²ÑƒÑ Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¸ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° macOS:

- ğŸŸ¢ **ĞĞµÑ‚ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²** â€” fakeredis, NoOp storage, AsyncMock
- ğŸŸ¢ **Async-first** â€” Ğ²ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ pytest-asyncio
- ğŸŸ¢ **Ğ˜Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ fixtures** â€” ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ‚ĞµÑÑ‚ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ñ‡Ğ¸ÑÑ‚Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
- ğŸŸ¢ **ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ** â€” Ğ»ĞµĞ³ĞºĞ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ blueprints
- ğŸŸ¢ **100% ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ macOS** â€” Ğ½ĞµÑ‚ platform-specific ĞºĞ¾Ğ´Ğ°
