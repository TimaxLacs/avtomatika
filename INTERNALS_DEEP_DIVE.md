# Ğ“Ğ»ÑƒĞ±Ğ¾ĞºĞ¾Ğµ Ğ¿Ğ¾Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ: Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Orchestrator Ğ¸ Worker

## ğŸ“‹ ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

1. [ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ](#ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ-Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ)
2. [Orchestrator: Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾](#orchestrator-Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ-ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾)
3. [Worker: Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾](#worker-Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ-ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾)
4. [ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ](#Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»-Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ)
5. [Ğ–Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸](#Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹-Ñ†Ğ¸ĞºĞ»-Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸)
6. [ĞœĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸](#Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹-ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸)
7. [ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº](#Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°-Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº)

---

## ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ

### Ğ¤Ğ¸Ğ»Ğ¾ÑĞ¾Ñ„Ğ¸Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹

Avtomatika Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğµ **Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ORCHESTRATOR                                     â”‚
â”‚   "Ğ¯ Ğ·Ğ½Ğ°Ñ Ğ§Ğ¢Ğ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¸ ĞšĞĞ“Ğ”Ğ, Ğ½Ğ¾ ĞĞ• Ğ·Ğ½Ğ°Ñ ĞšĞĞš"                    â”‚
â”‚                                                                          â”‚
â”‚   âœ“ Ğ¥Ñ€Ğ°Ğ½Ğ¸Ñ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²                                          â”‚
â”‚   âœ“ ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº ÑˆĞ°Ğ³Ğ¾Ğ²                                            â”‚
â”‚   âœ“ Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ñ                                                â”‚
â”‚   âœ“ ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ¸ retry                                         â”‚
â”‚   âœ— ĞĞ• Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚  Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ (Ñ‡Ñ‚Ğ¾ ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ)
                                    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
                                    â”‚
                                    â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                    â”‚  Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ (Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ¾ÑÑŒ)
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           WORKER                                         â”‚
â”‚   "Ğ¯ Ğ·Ğ½Ğ°Ñ ĞšĞĞš Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸, Ğ½Ğ¾ ĞĞ• Ğ·Ğ½Ğ°Ñ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ğ¿Ğ»Ğ°Ğ½"       â”‚
â”‚                                                                          â”‚
â”‚   âœ“ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸                                         â”‚
â”‚   âœ“ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ ÑĞ²Ğ¾Ğ¸Ğ¼Ğ¸ Ñ€ĞµÑÑƒÑ€ÑĞ°Ğ¼Ğ¸ (GPU, Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ)                           â”‚
â”‚   âœ“ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰Ğ°ĞµÑ‚ Ğ¾ ÑĞ²Ğ¾Ğ¸Ñ… Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑÑ…                                       â”‚
â”‚   âœ— ĞĞ• Ğ·Ğ½Ğ°ĞµÑ‚ Ğ¾ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… ÑˆĞ°Ğ³Ğ°Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°                                    â”‚
â”‚   âœ— ĞĞ• Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ğ¼Ğ¸                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ: PULL vs PUSH

Avtomatika Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **PULL-Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ**:

```
      PUSH-Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ (ĞĞ• Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ)         PULL-Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ (Avtomatika)
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      Orchestrator                          Orchestrator
           â”‚                                     â”‚
           â”‚ "Ğ’Ğ¾Ñ‚ Ñ‚ĞµĞ±Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°!"                  â”‚ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
           â–¼                                     â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Worker  â”‚                           â”‚ Worker  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â”‚ "Ğ•ÑÑ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ´Ğ»Ñ Ğ¼ĞµĞ½Ñ?"
                                                 â–¼
                                            Orchestrator
      
      ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹:                             ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:
      â€¢ Worker Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ½ÑÑ‚            â€¢ Worker Ğ±ĞµÑ€Ñ‘Ñ‚ ĞºĞ¾Ğ³Ğ´Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²
      â€¢ ĞÑƒĞ¶ĞµĞ½ callback URL                 â€¢ ĞĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ NAT/firewall
      â€¢ Ğ¡Ğ»Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ               â€¢ Ğ•ÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ load balancing
```

---

## Orchestrator: Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           OrchestratorEngine                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         HTTP Layer (aiohttp)                         â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  Client API   â”‚  â”‚  Worker API   â”‚  â”‚     Public API        â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  /api/v1/*    â”‚  â”‚  /_worker/*   â”‚  â”‚     /_public/*        â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚          â”‚                  â”‚                      â”‚               â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚                    Middleware Chain                          â”‚   â”‚   â”‚
â”‚   â”‚  â”‚  [Compression] â†’ [Auth] â†’ [Rate Limit] â†’ [Quota] â†’ Handler  â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Business Logic Layer                              â”‚   â”‚
â”‚   â”‚                                  â”‚                                   â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚  Blueprints   â”‚    â”‚    Dispatcher     â”‚    â”‚  WebSocket Mgr  â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  (State       â”‚â—„â”€â”€â”€â”‚  (Worker          â”‚    â”‚  (Real-time     â”‚  â”‚   â”‚
â”‚   â”‚  â”‚   Machines)   â”‚    â”‚   Selection)      â”‚    â”‚   Commands)     â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                      â”‚                                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                   Background Services                                â”‚   â”‚
â”‚   â”‚                                  â”‚                                   â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚  â”‚  Watcher    â”‚  â”‚    JobExecutor        â”‚  â”‚  Reputation       â”‚  â”‚   â”‚
â”‚   â”‚  â”‚  (Timeouts) â”‚  â”‚    (Main Loop)        â”‚  â”‚  Calculator       â”‚  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚         â”‚                    â”‚                         â”‚            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                    â”‚                         â”‚                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                        Storage Layer                                 â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚   â”‚  â”‚      State Storage         â”‚  â”‚       History Storage          â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  (Redis / Memory)          â”‚  â”‚   (PostgreSQL / SQLite)        â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Job states              â”‚  â”‚   â€¢ Event log                  â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Worker registry         â”‚  â”‚   â€¢ Audit trail                â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Task queues             â”‚  â”‚   â€¢ Analytics                  â”‚ â”‚   â”‚
â”‚   â”‚  â”‚  â€¢ Distributed locks       â”‚  â”‚                                â”‚ â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### JobExecutor: Ğ¡ĞµÑ€Ğ´Ñ†Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

**JobExecutor** â€” ÑÑ‚Ğ¾ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ», ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸:

```python
class JobExecutor:
    async def run(self):
        """Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» â€” Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ job'Ñ‹ Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚."""
        while self._running:
            job_id = await self.storage.dequeue_job()  # Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‰ĞµĞµ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ
            if job_id:
                task = create_task(self._process_job(job_id))
                task.add_done_callback(self._handle_task_completion)
```

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ Job'Ğ°:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      _process_job(job_id)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ â”‚
                    â”‚    job'Ğ° Ğ¸Ğ· storage   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 2. ĞĞ°Ğ¹Ñ‚Ğ¸ blueprint    â”‚
                    â”‚    Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚   â”‚
                    â”‚    â€¢ JobContext       â”‚
                    â”‚    â€¢ ActionFactory    â”‚
                    â”‚    â€¢ DataStores       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 4. ĞĞ°Ğ¹Ñ‚Ğ¸ handler      â”‚
                    â”‚    Ğ´Ğ»Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾       â”‚
                    â”‚    ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 5. Dependency         â”‚
                    â”‚    Injection:         â”‚
                    â”‚    ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑŒ        â”‚
                    â”‚    Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ handler'Ğ°â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 6. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ handler  â”‚
                    â”‚    await handler(**kw)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 7. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ         â”‚
                    â”‚    Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¸Ğ·        â”‚
                    â”‚    ActionFactory      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                   â”‚                   â”‚
            â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ transition_to â”‚   â”‚ dispatch_task â”‚   â”‚ dispatch_     â”‚
    â”‚               â”‚   â”‚               â”‚   â”‚ parallel      â”‚
    â”‚ ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ²     â”‚   â”‚ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°      â”‚   â”‚               â”‚
    â”‚ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞµ     â”‚   â”‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸        â”‚   â”‚ ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ  â”‚
    â”‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ     â”‚   â”‚ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñƒ       â”‚   â”‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                   â”‚                   â”‚
            â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ enqueue_job() â”‚   â”‚ Dispatcher.   â”‚   â”‚ ĞĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾     â”‚
    â”‚ (Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ)   â”‚   â”‚ dispatch()    â”‚   â”‚ dispatch()    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dependency Injection Ğ² handler'Ğ°Ñ…

**ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¼Ğ°Ğ³Ğ¸Ñ Ğ¸Ğ½ÑŠĞµĞºÑ†Ğ¸Ğ¸ Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²:**

```python
# Handler Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ»ÑĞ±Ñ‹Ğµ Ğ¸Ğ· ÑÑ‚Ğ¸Ñ… Ğ°Ñ€Ğ³ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸:
@blueprint.handler_for("process")
async def process_handler(
    job_id: str,           # â† Ğ¸Ğ· JobContext
    initial_data: dict,    # â† Ğ¸Ğ· JobContext
    state_history: dict,   # â† Ğ¸Ğ· JobContext
    actions: ActionFactory,# â† Ğ¸Ğ· JobContext
    client: ClientConfig,  # â† Ğ¸Ğ· JobContext
    data_stores,           # â† Ğ¸Ğ· Blueprint
    output_path: str,      # â† Ğ¸Ğ· state_history (Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°)
    duration: int,         # â† Ğ¸Ğ· state_history
):
    ...
```

**ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ¸Ğ½ÑŠĞµĞºÑ†Ğ¸Ğ¸ Ğ² JobExecutor:**

```python
# Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¸Ğ· executor.py
handler_signature = signature(handler)
params_to_inject = {}

if "context" in handler_signature.parameters:
    # Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ â€” Ğ²ĞµÑÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¾Ğ´Ğ½Ğ¸Ğ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ¼
    params_to_inject["context"] = context
else:
    # ĞĞ¾Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ â€” Dependency Injection
    context_as_dict = context._asdict()
    
    for param_name in handler_signature.parameters:
        # 1. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ñ‰ĞµĞ¼ Ğ² Ğ¿Ğ¾Ğ»ÑÑ… JobContext
        if param_name in context_as_dict:
            params_to_inject[param_name] = context_as_dict[param_name]
        
        # 2. ĞŸĞ¾Ñ‚Ğ¾Ğ¼ Ğ² state_history (Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… ÑˆĞ°Ğ³Ğ¾Ğ²)
        elif param_name in context.state_history:
            params_to_inject[param_name] = context.state_history[param_name]
        
        # 3. ĞĞ°ĞºĞ¾Ğ½ĞµÑ† Ğ² initial_data
        elif param_name in context.initial_data:
            params_to_inject[param_name] = context.initial_data[param_name]

await handler(**params_to_inject)
```

### Dispatcher: Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°

**ĞŸĞ°Ğ¹Ğ¿Ğ»Ğ°Ğ¹Ğ½ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°:**

```
                        Ğ’ÑĞµ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñ‹ Ğ¸Ğ· storage
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ 1: status      â”‚
                    â”‚ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ "idle"         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ 2: task_type   â”‚
                    â”‚ Ğ’Ğ¾Ñ€ĞºĞµÑ€ ÑƒĞ¼ĞµĞµÑ‚ ÑÑ‚Ğ¾      â”‚
                    â”‚ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ?               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ 3: resources   â”‚
                    â”‚ GPU, Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸ Ñ‚.Ğ´.    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ 4: max_cost    â”‚
                    â”‚ Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ² Ğ±ÑĞ´Ğ¶ĞµÑ‚Ğµ?  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°      â”‚
                    â”‚ â€¢ default             â”‚
                    â”‚ â€¢ round_robin         â”‚
                    â”‚ â€¢ least_connections   â”‚
                    â”‚ â€¢ cheapest            â”‚
                    â”‚ â€¢ best_value          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                        Ğ’Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ²Ğ¾Ñ€ĞºĞµÑ€
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ enqueue_task_for_     â”‚
                    â”‚ worker(worker_id,     â”‚
                    â”‚ payload, priority)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°:**

```python
# DEFAULT: Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° "Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğµ" Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñ‹ (hot_cache), Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ´ĞµÑˆÑ‘Ğ²Ñ‹Ğµ
def _select_default(workers, task_type):
    warm = [w for w in workers if task_type in w.get("hot_cache", [])]
    pool = warm or workers
    cheapest = min(pool, key=lambda w: w.get("cost", inf))
    return choice([w for w in pool if w.get("cost") == cheapest])

# BEST_VALUE: Ğ›ÑƒÑ‡ÑˆĞµĞµ ÑĞ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ğ°/ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾
def _select_best_value(workers, task_type):
    # Score = cost_per_second / reputation (Ñ‡ĞµĞ¼ Ğ¼ĞµĞ½ÑŒÑˆĞµ, Ñ‚ĞµĞ¼ Ğ»ÑƒÑ‡ÑˆĞµ)
    return min(workers, key=lambda w: w.get("cost_per_second", inf) / w.get("reputation", 1.0))
```

### Watcher: ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ²

**ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑÑˆĞ¸Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        WATCHER FLOW                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ĞšĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñƒ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    timeout_at = now + timeout_seconds
    await storage.add_job_to_watch(job_id, timeout_at)
    
    Redis SORTED SET:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ "orchestrator:watched_jobs"            â”‚
    â”‚                                        â”‚
    â”‚  Score (timeout_at)  â”‚  Member        â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
    â”‚  1705312800.0        â”‚  job-abc       â”‚
    â”‚  1705312850.0        â”‚  job-def       â”‚
    â”‚  1705312900.0        â”‚  job-ghi       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Watcher loop (ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ WATCHER_INTERVAL_SECONDS):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    1. ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ğ¸Ñ‚ÑŒ distributed lock
       (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Orchestrator Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞ»)
       
    2. Ğ•ÑĞ»Ğ¸ lock Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½:
       
       now = current_time()
       
       timed_out = await storage.get_timed_out_jobs()
       # ZRANGEBYSCORE watched_jobs 0 {now}
       # ZREM watched_jobs {timed_out_ids}
       
       for job_id in timed_out:
           job_state["status"] = "failed"
           job_state["error_message"] = "Worker task timed out"
           await storage.save_job_state(job_id, job_state)
           
    3. ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ¸Ñ‚ÑŒ lock


ĞšĞ¾Ğ³Ğ´Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµÑ‚ÑÑ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    await storage.remove_job_from_watch(job_id)
    # ZREM watched_jobs {job_id}
```

---

## Worker: Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ĞµĞµ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Worker SDK

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                Worker                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      Main Event Loop                                 â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚   â”‚  â”‚  Communication  â”‚           â”‚    Polling      â”‚                  â”‚   â”‚
â”‚   â”‚  â”‚     Task        â”‚           â”‚     Task        â”‚                  â”‚   â”‚
â”‚   â”‚  â”‚                 â”‚           â”‚                 â”‚                  â”‚   â”‚
â”‚   â”‚  â”‚ â€¢ Registration  â”‚           â”‚ â€¢ GET /tasks/   â”‚                  â”‚   â”‚
â”‚   â”‚  â”‚ â€¢ Heartbeats    â”‚           â”‚   next          â”‚                  â”‚   â”‚
â”‚   â”‚  â”‚ â€¢ WebSocket     â”‚           â”‚ â€¢ Wait/Sleep    â”‚                  â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚   â”‚           â”‚                             â”‚                           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â”‚                             â”‚                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚           â”‚     Task Processing         â”‚                           â”‚   â”‚
â”‚   â”‚           â”‚                             â”‚                           â”‚   â”‚
â”‚   â”‚           â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚           â”‚    â”‚              Task Handlers                      â”‚   â”‚   â”‚
â”‚   â”‚           â”‚    â”‚                                                 â”‚   â”‚   â”‚
â”‚   â”‚           â”‚    â”‚  @worker.task("resize_image", task_type="gpu") â”‚   â”‚   â”‚
â”‚   â”‚           â”‚    â”‚  async def resize(params, **kwargs): ...       â”‚   â”‚   â”‚
â”‚   â”‚           â”‚    â”‚                                                 â”‚   â”‚   â”‚
â”‚   â”‚           â”‚    â”‚  @worker.task("transcribe", task_type="cpu")   â”‚   â”‚   â”‚
â”‚   â”‚           â”‚    â”‚  async def transcribe(params, **kwargs): ...   â”‚   â”‚   â”‚
â”‚   â”‚           â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚           â”‚                             â”‚                           â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               â”‚                             â”‚                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚           â”‚      State Management       â”‚                           â”‚   â”‚
â”‚   â”‚           â”‚                             â”‚                           â”‚   â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
â”‚   â”‚    â”‚ Hot Cache   â”‚              â”‚ Active Tasks  â”‚                   â”‚   â”‚
â”‚   â”‚    â”‚ (models)    â”‚              â”‚ (running)     â”‚                   â”‚   â”‚
â”‚   â”‚    â”‚             â”‚              â”‚               â”‚                   â”‚   â”‚
â”‚   â”‚    â”‚ Set[str]    â”‚              â”‚ Dict[task_id, â”‚                   â”‚   â”‚
â”‚   â”‚    â”‚             â”‚              â”‚      Task]    â”‚                   â”‚   â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚   â”‚    â”‚                    Concurrency Limits                        â”‚  â”‚   â”‚
â”‚   â”‚    â”‚                                                              â”‚  â”‚   â”‚
â”‚   â”‚    â”‚  max_concurrent_tasks = 10     (Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚)           â”‚  â”‚   â”‚
â”‚   â”‚    â”‚                                                              â”‚  â”‚   â”‚
â”‚   â”‚    â”‚  task_type_limits = {                                        â”‚  â”‚   â”‚
â”‚   â”‚    â”‚      "gpu": 1,        â† Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ 1 GPU-Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾    â”‚  â”‚   â”‚
â”‚   â”‚    â”‚      "cpu": 4,        â† Ğ”Ğ¾ 4 CPU-Ğ·Ğ°Ğ´Ğ°Ñ‡                      â”‚  â”‚   â”‚
â”‚   â”‚    â”‚  }                                                           â”‚  â”‚   â”‚
â”‚   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Worker'Ğ°

```python
async def main(self):
    """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°."""
    
    # 1. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ communication task (Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ + heartbeats)
    comm_task = asyncio.create_task(self._manage_orchestrator_communications())
    
    # 2. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ polling task (Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡)
    polling_task = asyncio.create_task(self._start_polling())
    
    # 3. Ğ–Ğ´Ñ‘Ğ¼ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ğ° Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸
    await self._shutdown_event.wait()
    
    # 4. Graceful shutdown
    for task in [comm_task, polling_task]:
        task.cancel()
    
    # 5. Ğ”Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒÑÑ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡
    await asyncio.gather(*self._active_tasks.values(), return_exceptions=True)
```

### Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ

**Worker Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰Ğ°ĞµÑ‚ ÑĞ²Ğ¾Ğ¸ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸:**

```python
def _get_current_state(self) -> Dict[str, Any]:
    """Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°."""
    
    # Ğ•ÑĞ»Ğ¸ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ³Ğ½ÑƒÑ‚ â€” busy
    if self._current_load >= self._config.max_concurrent_tasks:
        return {"status": "busy", "supported_tasks": []}
    
    supported_tasks = []
    
    for task_name, handler_data in self._task_handlers.items():
        is_available = True
        task_type = handler_data.get("type")  # e.g., "gpu", "cpu"
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
        if task_type and task_type in self._task_type_limits:
            limit = self._task_type_limits[task_type]
            current_load = self._current_load_by_type.get(task_type, 0)
            
            if current_load >= limit:
                is_available = False  # Ğ­Ñ‚Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿ Ğ·Ğ°Ğ´Ğ°Ñ‡ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
        
        if is_available:
            supported_tasks.append(task_name)
    
    status = "idle" if supported_tasks else "busy"
    return {"status": status, "supported_tasks": supported_tasks}
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ ÑĞ²Ğ¾Ğ»ÑÑ†Ğ¸Ğ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ:**

```
ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
max_concurrent_tasks = 10
task_type_limits = {"gpu": 1, "cpu": 4}
current_load = 0

State: {
    "status": "idle",
    "supported_tasks": ["resize_image", "upscale_video", "transcribe", "generate_report"]
}


ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° GPU-Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ (upscale_video):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
current_load = 1
current_load_by_type = {"gpu": 1, "cpu": 0}

State: {
    "status": "idle",
    "supported_tasks": ["resize_image", "transcribe", "generate_report"]
    # upscale_video Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½ â€” GPU-ÑĞ»Ğ¾Ñ‚ Ğ·Ğ°Ğ½ÑÑ‚!
}


ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° 4 CPU-Ğ·Ğ°Ğ´Ğ°Ñ‡:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
current_load = 5
current_load_by_type = {"gpu": 1, "cpu": 4}

State: {
    "status": "idle",
    "supported_tasks": ["resize_image", "generate_report"]
    # transcribe Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½ â€” Ğ²ÑĞµ CPU-ÑĞ»Ğ¾Ñ‚Ñ‹ Ğ·Ğ°Ğ½ÑÑ‚Ñ‹!
    # upscale_video Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½ â€” GPU-ÑĞ»Ğ¾Ñ‚ Ğ·Ğ°Ğ½ÑÑ‚!
}


ĞŸĞ¾ÑĞ»Ğµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ° (10):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
current_load = 10

State: {
    "status": "busy",
    "supported_tasks": []  # Ğ’Ğ¾Ğ¾Ğ±Ñ‰Ğµ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ğ²Ğ·ÑÑ‚ÑŒ!
}
```

### Hot Cache Ğ¸ Skill Dependencies

**ĞœĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼ Ğ´Ğ»Ñ ÑƒĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ñ ML-Ğ¼Ğ¾Ğ´ĞµĞ»ÑĞ¼Ğ¸:**

```python
worker = Worker(
    skill_dependencies={
        "image_generation": ["stable_diffusion_v1.5", "vae-ft-mse"],
        "upscale": ["realesrgan_x4"],
    }
)

@worker.task("image_generation")
async def generate(params, add_to_hot_cache, **kwargs):
    # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ (Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğ°Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ)
    model = load_model("stable_diffusion_v1.5")
    add_to_hot_cache("stable_diffusion_v1.5")  # Ğ¡Ğ¾Ğ¾Ğ±Ñ‰Ğ°ĞµĞ¼ Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
    
    vae = load_model("vae-ft-mse")
    add_to_hot_cache("vae-ft-mse")
    
    return {"status": "success", "data": model.generate(params)}
```

**Ğ§Ñ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ÑÑ Ğ² heartbeat:**

```python
payload = {
    "status": "idle",
    "supported_tasks": ["image_generation", "upscale"],
    "hot_cache": ["stable_diffusion_v1.5", "vae-ft-mse"],  # Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
    
    # Skill dependencies (ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ)
    "skill_dependencies": {
        "image_generation": ["stable_diffusion_v1.5", "vae-ft-mse"],
        "upscale": ["realesrgan_x4"],
    },
    
    # Hot skills (Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ) â€” Ğ½Ğ°Ğ²Ñ‹ĞºĞ¸, Ğ´Ğ»Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ’Ğ¡Ğ• Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹
    "hot_skills": ["image_generation"]  # upscale ĞĞ• Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½ â€” realesrgan Ğ½Ğµ Ğ² hot_cache
}
```

**Orchestrator Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ñƒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ** Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°Ğ¼, Ñƒ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹.

---

## ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ

### Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker â”‚                              â”‚ Orchestratorâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                          â”‚
    â”‚  POST /_worker/workers/register          â”‚
    â”‚  {                                       â”‚
    â”‚    "worker_id": "gpu-worker-01",         â”‚
    â”‚    "worker_type": "gpu_worker",          â”‚
    â”‚    "supported_tasks": ["resize", ...],   â”‚
    â”‚    "max_concurrent_tasks": 10,           â”‚
    â”‚    "resources": {...},                   â”‚
    â”‚    "installed_models": [...]             â”‚
    â”‚  }                                       â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                                          â”‚
    â”‚                                          â”‚ storage.register_worker(
    â”‚                                          â”‚   worker_id, info, ttl=120
    â”‚                                          â”‚ )
    â”‚                                          â”‚
    â”‚  200 OK {"status": "registered"}         â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                          â”‚
```

### Heartbeat (Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ Ğ¶Ğ¸Ğ·Ğ½Ğ¸)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker â”‚                              â”‚ Orchestratorâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                          â”‚
    â”‚  ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 15 ÑĞµĞºÑƒĞ½Ğ´:                       â”‚
    â”‚                                          â”‚
    â”‚  PATCH /_worker/workers/{worker_id}      â”‚
    â”‚  {                                       â”‚
    â”‚    "load": 3,                            â”‚
    â”‚    "status": "idle",                     â”‚
    â”‚    "supported_tasks": ["resize", ...],   â”‚
    â”‚    "hot_cache": ["model_a", "model_b"]   â”‚
    â”‚  }                                       â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                                          â”‚
    â”‚                                          â”‚ storage.update_worker_status(
    â”‚                                          â”‚   worker_id, update, ttl=120
    â”‚                                          â”‚ )
    â”‚                                          â”‚
    â”‚  200 OK {updated_worker_info}            â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                          â”‚
    â”‚                                          â”‚
    â”‚  Ğ˜Ğ»Ğ¸ "Ğ»Ñ‘Ğ³ĞºĞ¸Ğ¹" heartbeat (Ğ±ĞµĞ· Ñ‚ĞµĞ»Ğ°):      â”‚
    â”‚                                          â”‚
    â”‚  PATCH /_worker/workers/{worker_id}      â”‚
    â”‚  (empty body)                            â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                                          â”‚
    â”‚                                          â”‚ storage.refresh_worker_ttl(
    â”‚                                          â”‚   worker_id, ttl=120
    â”‚                                          â”‚ )
    â”‚                                          â”‚
    â”‚  200 OK {"status": "ttl_refreshed"}      â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker â”‚                              â”‚ Orchestratorâ”‚                    â”‚ Redis  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                                          â”‚                               â”‚
    â”‚  GET /_worker/workers/{id}/tasks/next    â”‚                               â”‚
    â”‚  (long polling, timeout=30s)             â”‚                               â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                               â”‚
    â”‚                                          â”‚                               â”‚
    â”‚                                          â”‚  BZPOPMAX task_queue:{id} 30  â”‚
    â”‚                                          â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                                          â”‚                               â”‚
    â”‚                                          â”‚  (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ´Ğ¾ 30 ÑĞµĞº)      â”‚
    â”‚                                          â”‚                               â”‚
    â”‚                                          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                          â”‚  task_payload                 â”‚
    â”‚                                          â”‚                               â”‚
    â”‚  200 OK                                  â”‚                               â”‚
    â”‚  {                                       â”‚                               â”‚
    â”‚    "job_id": "job-abc",                  â”‚                               â”‚
    â”‚    "task_id": "task-123",                â”‚                               â”‚
    â”‚    "type": "resize_image",               â”‚                               â”‚
    â”‚    "params": {"path": "...", "size": 800}â”‚                               â”‚
    â”‚  }                                       â”‚                               â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚
    â”‚                                          â”‚                               â”‚
    â”‚                                          â”‚                               â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚                               â”‚
    â”‚  â•‘  Worker Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ        â•‘     â”‚                               â”‚
    â”‚  â•‘  (Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ ÑĞµĞºÑƒĞ½Ğ´Ñ‹/Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹)  â•‘     â”‚                               â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â”‚                               â”‚
    â”‚                                          â”‚                               â”‚
    â”‚                                          â”‚                               â”‚
    â”‚  POST /_worker/tasks/result              â”‚                               â”‚
    â”‚  {                                       â”‚                               â”‚
    â”‚    "job_id": "job-abc",                  â”‚                               â”‚
    â”‚    "task_id": "task-123",                â”‚                               â”‚
    â”‚    "worker_id": "gpu-worker-01",         â”‚                               â”‚
    â”‚    "result": {                           â”‚                               â”‚
    â”‚      "status": "success",                â”‚                               â”‚
    â”‚      "data": {"output_path": "/out/..."}â”‚                               â”‚
    â”‚    }                                     â”‚                               â”‚
    â”‚  }                                       â”‚                               â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                               â”‚
    â”‚                                          â”‚                               â”‚
    â”‚                                          â”‚ â€¢ remove_job_from_watch()     â”‚
    â”‚                                          â”‚ â€¢ Merge data Ğ² state_history  â”‚
    â”‚                                          â”‚ â€¢ Transition to next state    â”‚
    â”‚                                          â”‚ â€¢ enqueue_job()               â”‚
    â”‚                                          â”‚                               â”‚
    â”‚  200 OK                                  â”‚                               â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                               â”‚
```

### WebSocket: ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Worker â”‚â—„â•â•â•â•â•â•â• WebSocket â•â•â•â•â•â•â•â•â•â•â–ºâ”‚ Orchestratorâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                          â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
    â”‚  â•‘ WebSocket connection established   â•‘  â”‚
    â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
    â”‚                                          â”‚
    â”‚                                          â”‚  ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚:
    â”‚                                          â”‚  POST /api/v1/jobs/{id}/cancel
    â”‚                                          â”‚
    â”‚                                          â”‚
    â”‚  WS Message:                             â”‚
    â”‚  {                                       â”‚
    â”‚    "command": "cancel_task",             â”‚
    â”‚    "task_id": "task-123",                â”‚
    â”‚    "job_id": "job-abc"                   â”‚
    â”‚  }                                       â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                          â”‚
    â”‚                                          â”‚
    â”‚  Worker Ğ¾Ñ‚Ğ¼ĞµĞ½ÑĞµÑ‚ asyncio.Task            â”‚
    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚
    â”‚  self._active_tasks["task-123"].cancel() â”‚
    â”‚                                          â”‚
    â”‚                                          â”‚
    â”‚  POST /_worker/tasks/result              â”‚
    â”‚  {                                       â”‚
    â”‚    "result": {"status": "cancelled"}     â”‚
    â”‚  }                                       â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                                          â”‚
```

---

## Ğ–Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸

### ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ÑƒÑ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        TASK LIFECYCLE                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 Client                Orchestrator              Redis                Worker
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚ POST /api/v1/jobs     â”‚                      â”‚                      â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  job_state = {...}   â”‚                      â”‚
    â”‚                       â”‚  status: "pending"   â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  LPUSH job_queue     â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚ 202 {job_id}          â”‚                      â”‚                      â”‚
    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                      â”‚
    â”‚            â”‚    JobExecutor      â”‚           â”‚                      â”‚
    â”‚            â”‚    (background)     â”‚           â”‚                      â”‚
    â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  BRPOP job_queue     â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚                       â”‚  job_id              â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  GET job:{id}        â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚                       â”‚  job_state           â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚                      â”‚
    â”‚                       â”‚  â•‘ Execute handler â•‘  â”‚                      â”‚
    â”‚                       â”‚  â•‘ â†’ dispatch_task â•‘  â”‚                      â”‚
    â”‚                       â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                      â”‚
    â”‚            â”‚     Dispatcher      â”‚           â”‚                      â”‚
    â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  SCAN workers:*      â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚                       â”‚  [worker_infos]      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  Filter & Select     â”‚                      â”‚
    â”‚                       â”‚  â†’ gpu-worker-01     â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  ZADD task_queue:    â”‚                      â”‚
    â”‚                       â”‚    {gpu-worker-01}   â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  ZADD watched_jobs   â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  SET job:{id}        â”‚                      â”‚
    â”‚                       â”‚  status: "waiting"   â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚  GET tasks/next      â”‚
    â”‚                       â”‚                      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  BZPOPMAX queue:     â”‚                      â”‚
    â”‚                       â”‚    {gpu-worker-01}   â”‚                      â”‚
    â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚  200 OK task_payload â”‚
    â”‚                       â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
    â”‚                       â”‚                      â”‚  â•‘ Execute task    â•‘â”‚
    â”‚                       â”‚                      â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚  POST tasks/result   â”‚
    â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  ZREM watched_jobs   â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  Merge result data   â”‚                      â”‚
    â”‚                       â”‚  into state_history  â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  SET job:{id}        â”‚                      â”‚
    â”‚                       â”‚  current_state: next â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  LPUSH job_queue     â”‚                      â”‚
    â”‚                       â”‚  (Ğ´Ğ»Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾     â”‚                      â”‚
    â”‚                       â”‚   ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ)         â”‚                      â”‚
    â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
    â”‚                       â”‚  ... Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ğµ ... â”‚                      â”‚
    â”‚                       â”‚                      â”‚                      â”‚
```

---

## ĞœĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼Ñ‹ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸

### Distributed Locks

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** ĞĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€Ğ¾Ğ² Orchestrator Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Watcher Ğ¸Ğ»Ğ¸ ReputationCalculator.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Distributed locks Ñ‡ĞµÑ€ĞµĞ· Redis SET NX:

```python
# ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ·Ğ°Ñ…Ğ²Ğ°Ñ‚Ğ¸Ñ‚ÑŒ lock
async def acquire_lock(self, key: str, holder_id: str, ttl: int) -> bool:
    redis_key = f"orchestrator:lock:{key}"
    # SET key value NX EX ttl
    # NX = Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ ĞºĞ»ÑÑ‡ ĞĞ• ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚
    result = await self._redis.set(redis_key, holder_id, nx=True, ex=ttl)
    return bool(result)

# ĞÑĞ²Ğ¾Ğ±Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ lock'Ğ° (Ğ°Ñ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾, Ñ‡ĞµÑ€ĞµĞ· Lua)
async def release_lock(self, key: str, holder_id: str) -> bool:
    LUA_SCRIPT = """
    if redis.call("get", KEYS[1]) == ARGV[1] then
        return redis.call("del", KEYS[1])
    else
        return 0
    end
    """
    result = await self._redis.eval(LUA_SCRIPT, 1, redis_key, holder_id)
    return bool(result)
```

**Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ² Watcher:**

```python
async def run(self):
    while self._running:
        await sleep(self.watch_interval_seconds)
        
        # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ
        if await self.storage.acquire_lock("global_watcher_lock", self._instance_id, 60):
            try:
                await self._check_timed_out_jobs()
            finally:
                await self.storage.release_lock("global_watcher_lock", self._instance_id)
        else:
            logger.debug("Lock held by another instance, skipping.")
```

### Priority Queue Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡

**Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°:** Redis Sorted Set

```
Key: orchestrator:task_queue:{worker_id}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Score (priority)   â”‚  Member (JSON payload)             â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ 10.0               â”‚  {"job_id": "urgent-job", ...}     â”‚  â† Ğ’Ñ‹ÑÑˆĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚
â”‚ 5.0                â”‚  {"job_id": "normal-job", ...}     â”‚
â”‚ 1.0                â”‚  {"job_id": "low-prio-job", ...}   â”‚  â† ĞĞ¸Ğ·ÑˆĞ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:**

```python
# Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ¾Ğ¼
await redis.zadd(key, {json_payload: priority})

# ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñ ĞĞĞ˜Ğ’Ğ«Ğ¡Ğ¨Ğ˜Ğœ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ¾Ğ¼ (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‰ĞµĞµ)
result = await redis.bzpopmax([key], timeout=30)
# result = (key, payload, score)
```

### TTL Ğ´Ğ»Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²

**ĞœĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼:** Redis EXPIRE

```
Worker Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ:
    SET orchestrator:worker:info:{worker_id} {...} EX 120
    
    â”‚
    â”‚  TTL = 120 ÑĞµĞºÑƒĞ½Ğ´
    â”‚
    â”œâ”€â”€ Heartbeat ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 15 ÑĞµĞºÑƒĞ½Ğ´:
    â”‚       EXPIRE orchestrator:worker:info:{worker_id} 120
    â”‚       (ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€)
    â”‚
    â”‚
    â”‚  Ğ•ÑĞ»Ğ¸ heartbeat Ğ½Ğµ Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ» 120 ÑĞµĞºÑƒĞ½Ğ´:
    â”‚
    â–¼
    
    Redis Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ ĞºĞ»ÑÑ‡
    â†’ Ğ’Ğ¾Ñ€ĞºĞµÑ€ Ğ¸ÑÑ‡ĞµĞ·Ğ°ĞµÑ‚ Ğ¸Ğ· get_available_workers()
```

---

## ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

### Ğ¢Ğ¸Ğ¿Ñ‹ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¾Ñ‚ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°

```python
# Worker Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚:
{
    "status": "failure",
    "error": {
        "code": "TRANSIENT_ERROR | PERMANENT_ERROR | INVALID_INPUT_ERROR",
        "message": "ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸"
    }
}
```

### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ² Orchestrator

```
                    Worker Result: failure
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   ĞšĞ°ĞºĞ¾Ğ¹ error.code?   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRANSIENT_    â”‚   â”‚ PERMANENT_    â”‚   â”‚ INVALID_      â”‚
â”‚ ERROR         â”‚   â”‚ ERROR         â”‚   â”‚ INPUT_ERROR   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ retry_count   â”‚   â”‚ Ğ¡Ñ€Ğ°Ğ·Ñƒ Ğ²       â”‚   â”‚ Ğ¡Ñ€Ğ°Ğ·Ñƒ Ğ²       â”‚
â”‚ < MAX?        â”‚   â”‚ quarantine    â”‚   â”‚ failed        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   Yes  â”‚  No
   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   â”‚         â”‚
   â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Retry â”‚  â”‚Quarantineâ”‚
â”‚Task  â”‚  â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Retry Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

```python
async def _handle_task_failure(self, job_state, task_id, error_message):
    retry_count = job_state.get("retry_count", 0)
    max_retries = self.config.JOB_MAX_RETRIES  # default: 3
    
    if retry_count < max_retries:
        # Ğ˜Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº
        job_state["retry_count"] = retry_count + 1
        
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğµ
        task_info = job_state.get("current_task_info")
        
        # ĞŸĞµÑ€ĞµÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ timeout
        timeout_at = now + task_info.get("timeout_seconds", 300)
        
        # Ğ¡Ğ½Ğ¾Ğ²Ğ° ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼ Ğ² watch list
        await self.storage.add_job_to_watch(job_id, timeout_at)
        
        # ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ´Ğ¸ÑĞ¿Ğ°Ñ‚Ñ‡Ğ¸Ğ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ
        await self.dispatcher.dispatch(job_state, task_info)
    else:
        # Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ Ğ¸ÑÑ‡ĞµÑ€Ğ¿Ğ°Ğ½ â†’ quarantine
        job_state["status"] = "quarantined"
        await self.storage.quarantine_job(job_id)
```

### Quarantine

**Ğ§Ñ‚Ğ¾ ÑÑ‚Ğ¾:** Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ´Ğ»Ñ job'Ğ¾Ğ², ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ¼ĞµÑˆĞ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ°.

```python
# Ğ’ Redis
LPUSH orchestrator:quarantine_queue {job_id}

# ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ°
LRANGE orchestrator:quarantine_queue 0 -1
```

**API Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°:**
```
GET /_public/jobs/quarantined
â†’ ["job-abc", "job-def", ...]
```

---

## Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ…ĞµĞ¼Ğ° Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                      â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                              â”‚      Clients        â”‚                                 â”‚
â”‚                              â”‚   (API consumers)   â”‚                                 â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                         â”‚                                            â”‚
â”‚                                         â”‚ HTTP (REST API)                            â”‚
â”‚                                         â”‚                                            â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                              â”‚                     â”‚                                 â”‚
â”‚                              â”‚    Orchestrator     â”‚                                 â”‚
â”‚                              â”‚                     â”‚                                 â”‚
â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                 â”‚
â”‚                              â”‚  â”‚  JobExecutor  â”‚â—„â”€â”¼â”€â”€â”€â”€ Job Queue (Redis LIST)      â”‚
â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                 â”‚
â”‚                              â”‚          â”‚          â”‚                                 â”‚
â”‚                              â”‚          â”‚          â”‚                                 â”‚
â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                 â”‚
â”‚                              â”‚  â”‚  Dispatcher   â”‚â”€â”€â”¼â”€â”€â”€â”€ Worker Registry (Redis)     â”‚
â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                 â”‚
â”‚                              â”‚          â”‚          â”‚                                 â”‚
â”‚                              â”‚          â”‚          â”‚                                 â”‚
â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                 â”‚
â”‚                              â”‚  â”‚ Task Queues   â”‚â”€â”€â”¼â”€â”€â”€â”€ Per-Worker Queues (ZSET)    â”‚
â”‚                              â”‚  â”‚ (per worker)  â”‚  â”‚                                 â”‚
â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                 â”‚
â”‚                              â”‚          â”‚          â”‚                                 â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                         â”‚                                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚                    â”‚                    â”‚                       â”‚
â”‚                    â”‚                    â”‚                    â”‚                       â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚           â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚           â”‚    Worker 1     â”‚  â”‚    Worker 2     â”‚  â”‚    Worker N     â”‚              â”‚
â”‚           â”‚   (GPU tasks)   â”‚  â”‚   (CPU tasks)   â”‚  â”‚      (...)      â”‚              â”‚
â”‚           â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚           â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚
â”‚           â”‚ â”‚Task Handlersâ”‚ â”‚  â”‚ â”‚Task Handlersâ”‚ â”‚  â”‚ â”‚Task Handlersâ”‚ â”‚              â”‚
â”‚           â”‚ â”‚â€¢ resize     â”‚ â”‚  â”‚ â”‚â€¢ transcribe â”‚ â”‚  â”‚ â”‚â€¢ ...        â”‚ â”‚              â”‚
â”‚           â”‚ â”‚â€¢ upscale    â”‚ â”‚  â”‚ â”‚â€¢ analyze    â”‚ â”‚  â”‚ â”‚             â”‚ â”‚              â”‚
â”‚           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚
â”‚           â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚              â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                                      â”‚
â”‚                    â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²                       â”‚
â”‚                    â”‚                    â”‚                    â”‚                       â”‚
â”‚                    â”‚   PULL (HTTP)      â”‚   WebSocket        â”‚                       â”‚
â”‚                    â”‚   GET tasks/next   â”‚   (commands)       â”‚                       â”‚
â”‚                    â”‚   POST result      â”‚                    â”‚                       â”‚
â”‚                    â”‚                    â”‚                    â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¸Ğ½Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

1. **Job Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¸Ğ¼ĞµĞµÑ‚ Ñ€Ğ¾Ğ²Ğ½Ğ¾ Ğ¾Ğ´Ğ½Ğ¾ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ**
   - ĞĞµÑ‚ "Ğ¼ĞµĞ¶Ğ´Ñƒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ÑĞ¼Ğ¸" â€” Ğ»Ğ¸Ğ±Ğ¾ running, Ğ»Ğ¸Ğ±Ğ¾ waiting

2. **Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ action Ğ·Ğ° ÑˆĞ°Ğ³**
   - Handler Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞĞ”Ğ˜Ğ Ğ¸Ğ·: `transition_to`, `dispatch_task`, `dispatch_parallel`, `run_blueprint`

3. **Worker Ğ±ĞµÑ€Ñ‘Ñ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ ĞºĞ¾Ğ³Ğ´Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²**
   - ĞĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡
   - Ğ•ÑÑ‚ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ backpressure

4. **TTL Ğ´Ğ»Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²**
   - ĞĞµÑ‚ heartbeat > 2 Ã— interval = Ğ²Ğ¾Ñ€ĞºĞµÑ€ Ğ¼Ñ‘Ñ€Ñ‚Ğ²
   - Redis Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚

5. **Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²**
   - ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° (Ğ¿Ñ€Ğ¸ network retry) Ğ½Ğµ Ğ»Ğ¾Ğ¼Ğ°ĞµÑ‚ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ

6. **Distributed locks Ğ´Ğ»Ñ singleton-Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²**
   - Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Watcher/ReputationCalculator Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½ Ğ² ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğµ
