# ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Avtomatika

## ğŸ“‹ ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

1. [ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ](#Ğ¾Ğ±Ñ‰ĞµĞµ-Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ)
2. [ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹](#Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°-ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹)
3. [Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°](#ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°-Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°)
4. [ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹](#Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ-ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹)
5. [ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…](#Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸-Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
6. [API Ğ¸ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»Ñ‹ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ](#api-Ğ¸-Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»Ñ‹-Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ)
7. [Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…](#Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ°-Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
8. [ĞÑ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ](#Ğ¾Ñ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ-Ğ¸-Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
9. [Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ](#Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ)
10. [Observability (ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ Ğ¸ Ñ‚Ñ€ĞµĞ¹ÑĞ¸Ğ½Ğ³)](#observability)
11. [Worker SDK](#worker-sdk)
12. [Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹](#Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹)

---

## ĞĞ±Ñ‰ĞµĞµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ

**Avtomatika** â€” ÑÑ‚Ğ¾ Ğ¼Ğ¾Ñ‰Ğ½Ñ‹Ğ¹, state-driven Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğ¼Ğ¸ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¼Ğ¸ workflow'Ğ°Ğ¼Ğ¸ Ğ² Python. ĞĞ½ Ğ¿Ñ€ĞµĞ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ñ„Ñ€ĞµĞ¹Ğ¼Ğ²Ğ¾Ñ€Ğº Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ñ… Ğ¸ Ğ¾Ñ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ñ‹Ñ… Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹, Ñ€Ğ°Ğ·Ğ´ĞµĞ»ÑÑ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ² Ğ¾Ñ‚ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ.

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸

| ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|----------|----------|
| Ğ’ĞµÑ€ÑĞ¸Ñ | 1.0b3 (Beta) |
| Python | >= 3.11 |
| Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ | MIT |
| ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° | State Machine + PULL-Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ² |
| HTTP Framework | aiohttp |
| Storage | Redis (prod), Memory (dev) |
| History | PostgreSQL, SQLite |

### ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ

ĞŸÑ€Ğ¾ĞµĞºÑ‚ Ğ±Ğ°Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ **Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ½Ğ¾Ğ¹ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸** Ğ¾Ñ‚ **Ğ»Ğ¾Ğ³Ğ¸ĞºĞ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Orchestrator  â”‚    â”‚   Blueprints    â”‚    â”‚    Workers      â”‚
â”‚   (Ğ”Ğ¸Ñ€Ğ¸Ğ¶Ñ‘Ñ€)     â”‚    â”‚   (Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹)    â”‚    â”‚  (Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»Ğ¸)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚     â”‚    â”‚ â€¢ ĞĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ÑÑ‚     â”‚    â”‚ â€¢ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑÑ‚     â”‚
â”‚   Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ¼     â”‚    â”‚   ÑˆĞ°Ğ³Ğ¸ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° â”‚    â”‚   ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ    â”‚
â”‚ â€¢ ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚   â”‚    â”‚ â€¢ ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑÑÑ‚    â”‚    â”‚   Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸        â”‚
â”‚   ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ     â”‚    â”‚   Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñ‹      â”‚    â”‚ â€¢ ĞĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹    â”‚
â”‚ â€¢ ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚  â”‚    â”‚ â€¢ State Machine â”‚    â”‚ â€¢ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰Ğ°ÑÑ‚      â”‚
â”‚   Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸        â”‚    â”‚                 â”‚    â”‚   Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### Ğ’Ñ‹ÑĞ¾ĞºĞ¾ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚              OrchestratorEngine                  â”‚
                                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                    â”‚  â”‚  HTTP API â”‚  Worker   â”‚  Background     â”‚   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚  Server   â”‚  API      â”‚  Services       â”‚   â”‚
         â”‚   Clients    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚           â”‚           â”‚                 â”‚   â”‚
         â”‚  (API Users) â”‚           â”‚  â”‚  â€¢ Jobs   â”‚  â€¢ Reg    â”‚  â€¢ Executor     â”‚   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚  â€¢ Status â”‚  â€¢ Tasks  â”‚  â€¢ Watcher      â”‚   â”‚
                                    â”‚  â”‚  â€¢ Cancel â”‚  â€¢ WS     â”‚  â€¢ Reputation   â”‚   â”‚
                                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                    â”‚                    â”‚                            â”‚
                                    â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
                                    â”‚          â”‚    Dispatcher     â”‚                  â”‚
                                    â”‚          â”‚ (Routing Logic)   â”‚                  â”‚
                                    â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                    â”‚                                     â”‚
                    â–¼                                    â–¼                                     â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Redis Storage   â”‚             â”‚   History Storage    â”‚             â”‚     Workers      â”‚
         â”‚  (State + Queue) â”‚             â”‚  (PostgreSQL/SQLite) â”‚             â”‚   (PULL Model)   â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ â€¢ Job States     â”‚             â”‚ â€¢ Job Events Log     â”‚             â”‚ â€¢ Task Handlers  â”‚
         â”‚ â€¢ Worker Registryâ”‚             â”‚ â€¢ Worker Events Log  â”‚             â”‚ â€¢ Hot Cache      â”‚
         â”‚ â€¢ Task Queues    â”‚             â”‚ â€¢ Audit Trail        â”‚             â”‚ â€¢ WebSocket      â”‚
         â”‚ â€¢ Locks          â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ

ĞŸÑ€Ğ¾ĞµĞºÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **Ğ³Ğ¸Ğ±Ñ€Ğ¸Ğ´Ğ½ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ**:

1. **PULL-Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ** Ğ´Ğ»Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡ â€” Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñ‹ ÑĞ°Ğ¼Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ÑÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñƒ Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
2. **WebSocket** Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ â€” Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡, Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑ
3. **Heartbeat** Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²

---

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
avtomatika/
â”œâ”€â”€ pyproject.toml                    # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ°ĞºĞµÑ‚Ğ°
â”œâ”€â”€ pytest.ini                        # ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ pytest
â”œâ”€â”€ README.md                         # Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
â”‚
â”œâ”€â”€ src/avtomatika/                   # ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ°ĞºĞµÑ‚ Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
â”‚   â”œâ”€â”€ __init__.py                   # Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ API
â”‚   â”œâ”€â”€ api.html                      # Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ API (Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ğ°Ñ)
â”‚   â”œâ”€â”€ py.typed                      # ĞœĞ°Ñ€ĞºĞµÑ€ Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
â”‚   â”‚
â”‚   â”‚   # === Ğ¯Ğ”Ğ Ğ ===
â”‚   â”œâ”€â”€ engine.py                     # OrchestratorEngine - Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº
â”‚   â”œâ”€â”€ blueprint.py                  # StateMachineBlueprint - state machine
â”‚   â”œâ”€â”€ context.py                    # ActionFactory - ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸ÑĞ¼Ğ¸
â”‚   â”œâ”€â”€ executor.py                   # JobExecutor - Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ job'Ğ¾Ğ²
â”‚   â”œâ”€â”€ dispatcher.py                 # Dispatcher - Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡
â”‚   â”‚
â”‚   â”‚   # === ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ ===
â”‚   â”œâ”€â”€ config.py                     # Config - Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· env
â”‚   â”œâ”€â”€ data_types.py                 # Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (JobContext, etc.)
â”‚   â”œâ”€â”€ datastore.py                  # AsyncDictStore Ğ´Ğ»Ñ blueprints
â”‚   â”œâ”€â”€ client_config_loader.py       # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
â”‚   â”œâ”€â”€ worker_config_loader.py       # Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²
â”‚   â”‚
â”‚   â”‚   # === Ğ¤ĞĞĞĞ’Ğ«Ğ• Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡Ğ« ===
â”‚   â”œâ”€â”€ watcher.py                    # Watcher - Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ²
â”‚   â”œâ”€â”€ health_checker.py             # HealthChecker (Ğ¿Ğ°ÑÑĞ¸Ğ²Ğ½Ñ‹Ğ¹)
â”‚   â”œâ”€â”€ reputation.py                 # ReputationCalculator
â”‚   â”‚
â”‚   â”‚   # === Ğ¥Ğ ĞĞĞ˜Ğ›Ğ˜Ğ©Ğ ===
â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                   # StorageBackend - Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ ĞºĞ»Ğ°ÑÑ
â”‚   â”‚   â”œâ”€â”€ memory.py                 # MemoryStorage - Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
â”‚   â”‚   â””â”€â”€ redis.py                  # RedisStorage - Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°
â”‚   â”‚
â”‚   â”œâ”€â”€ history/
â”‚   â”‚   â”œâ”€â”€ base.py                   # HistoryStorageBase - Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ†Ğ¸Ñ
â”‚   â”‚   â”œâ”€â”€ noop.py                   # NoOpHistoryStorage - Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°
â”‚   â”‚   â”œâ”€â”€ sqlite.py                 # SQLiteHistoryStorage
â”‚   â”‚   â””â”€â”€ postgres.py               # PostgresHistoryStorage
â”‚   â”‚
â”‚   â”‚   # === MIDDLEWARE & SECURITY ===
â”‚   â”œâ”€â”€ security.py                   # ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²
â”‚   â”œâ”€â”€ ratelimit.py                  # Rate limiting
â”‚   â”œâ”€â”€ quota.py                      # ĞšĞ²Ğ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
â”‚   â”œâ”€â”€ compression.py                # Ğ¡Ğ¶Ğ°Ñ‚Ğ¸Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²
â”‚   â”‚
â”‚   â”‚   # === OBSERVABILITY ===
â”‚   â”œâ”€â”€ metrics.py                    # Prometheus Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
â”‚   â”œâ”€â”€ telemetry.py                  # OpenTelemetry Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°
â”‚   â”œâ”€â”€ logging_config.py             # ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
â”‚   â”‚
â”‚   â”‚   # === WEBSOCKET ===
â”‚   â””â”€â”€ ws_manager.py                 # WebSocketManager
â”‚
â”œâ”€â”€ avtomatika_worker/                # SDK Ğ´Ğ»Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ² (Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ°ĞºĞµÑ‚)
â”‚   â”œâ”€â”€ pyproject.toml
â”‚   â”œâ”€â”€ README.md
â”‚   â””â”€â”€ src/avtomatika_worker/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config.py                 # WorkerConfig
â”‚       â”œâ”€â”€ types.py                  # Ğ¢Ğ¸Ğ¿Ñ‹ Ğ´Ğ»Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²
â”‚       â””â”€â”€ worker.py                 # Worker - Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ĞºĞ»Ğ°ÑÑ
â”‚
â””â”€â”€ tests/                            # Ğ¢ĞµÑÑ‚Ñ‹
    â”œâ”€â”€ conftest.py                   # Pytest fixtures
    â”œâ”€â”€ clients.toml                  # Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
    â”œâ”€â”€ workers.toml                  # Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¸ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²
    â””â”€â”€ test_*.py                     # Ğ¢ĞµÑÑ‚Ñ‹
```

---

## ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

### 1. OrchestratorEngine (`engine.py`)

Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ´Ğ²Ğ¸Ğ¶Ğ¾Ğº ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹. ĞÑ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ·Ğ°:

- Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº HTTP-ÑĞµÑ€Ğ²ĞµÑ€Ğ° (aiohttp)
- Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ blueprints
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼ Ñ†Ğ¸ĞºĞ»Ğ¾Ğ¼ Ñ„Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ñ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
- ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ HTTP-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²

```python
class OrchestratorEngine:
    def __init__(self, storage: StorageBackend, config: Config):
        self.storage = storage
        self.config = config
        self.blueprints: Dict[str, StateMachineBlueprint] = {}
        self.history_storage: HistoryStorageBase = NoOpHistoryStorage()
        self.ws_manager = WebSocketManager()
        self.app = web.Application(middlewares=[compression_middleware])
```

**Lifecycle Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹:**
- `register_blueprint(blueprint)` â€” Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ state machine
- `setup()` â€” Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ñ€Ğ¾ÑƒÑ‚Ğ¾Ğ² Ğ¸ Ñ…ÑƒĞºĞ¾Ğ²
- `run()` â€” Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
- `start()` / `stop()` â€” Ğ½ĞµĞ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

**Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹:**
- `JobExecutor` â€” Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° job'Ğ¾Ğ² Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸
- `Watcher` â€” Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ²
- `ReputationCalculator` â€” Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ Ñ€ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²
- `HealthChecker` â€” Ğ¿Ğ°ÑÑĞ¸Ğ²Ğ½Ñ‹Ğ¹ (TTL Ğ² Redis)

### 2. StateMachineBlueprint (`blueprint.py`)

ĞĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ workflow ĞºĞ°Ğº state machine:

```python
class StateMachineBlueprint:
    def __init__(
        self,
        name: str,
        api_endpoint: Optional[str] = None,
        api_version: Optional[str] = None,
        data_stores: Any = None,
    ):
        self.name = name
        self.handlers: Dict[str, Callable] = {}
        self.aggregator_handlers: Dict[str, Callable] = {}
        self.conditional_handlers: list[ConditionalHandler] = []
        self.start_state: Optional[str] = None
        self.end_states: set[str] = set()
```

**Ğ”ĞµĞºĞ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñ‹:**
- `@blueprint.handler_for("state", is_start=True, is_end=False)` â€” Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
- `@blueprint.handler_for("state").when("condition")` â€” ÑƒÑĞ»Ğ¾Ğ²Ğ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº
- `@blueprint.aggregator_for("state")` â€” Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡

**Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:**
- `render_graph()` â€” Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ DOT-Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° Ğ´Ğ»Ñ Graphviz

### 3. ActionFactory (`context.py`)

Ğ¤Ğ°Ğ±Ñ€Ğ¸ĞºĞ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹, Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°Ñ Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°Ñ…:

```python
class ActionFactory:
    def transition_to(self, state: str)                    # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
    def dispatch_task(task_type, params, transitions, ...) # Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ´Ğ»Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°
    def dispatch_parallel(tasks, aggregate_into)           # ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
    def await_human_approval(integration, message, ...)    # ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºĞ°
    def run_blueprint(blueprint_name, initial_data, ...)   # Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾Ğ´-Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°
```

**ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ—Ğ° Ğ¾Ğ´Ğ¸Ğ½ ÑˆĞ°Ğ³ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞĞ”ĞĞ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ.

### 4. JobExecutor (`executor.py`)

ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ job'Ñ‹ Ğ¸Ğ· Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸:

```python
class JobExecutor:
    async def _process_job(self, job_id: str):
        # 1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ job'Ğ°
        # 2. ĞĞ°Ğ¹Ñ‚Ğ¸ blueprint Ğ¸ handler
        # 3. ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ñ dependency injection
        # 4. Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ handler
        # 5. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ (transition/dispatch/etc.)
```

**Dependency Injection:**
- `job_id`, `initial_data`, `state_history` â€” Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
- `actions` â€” ActionFactory
- `client` â€” ClientConfig
- `data_stores` â€” Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğµ Ñ€ĞµÑÑƒÑ€ÑÑ‹
- Ğ›ÑĞ±Ñ‹Ğµ ĞºĞ»ÑÑ‡Ğ¸ Ğ¸Ğ· `state_history` â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ñ‚ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²

### 5. Dispatcher (`dispatcher.py`)

Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°Ğ¼:

```python
class Dispatcher:
    async def dispatch(self, job_state: Dict, task_info: Dict):
        # 1. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑÑƒ (idle)
        # 2. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
        # 3. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ñ€ĞµÑÑƒÑ€ÑĞ°Ğ¼
        # 4. Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
        # 5. Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¿Ğ¾ ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸
        # 6. ĞŸĞ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°
```

**Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°:**
| Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|-----------|----------|
| `default` | Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° "Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğµ" (hot_cache), Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ´ĞµÑˆÑ‘Ğ²Ñ‹Ğµ |
| `round_robin` | ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾ ĞºÑ€ÑƒĞ³Ñƒ |
| `least_connections` | ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° |
| `cheapest` | ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ (cost_per_second) |
| `best_value` | Ğ›ÑƒÑ‡ÑˆĞµĞµ ÑĞ¾Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğµ Ñ†ĞµĞ½Ğ°/Ñ€ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ñ |

### 6. Watcher (`watcher.py`)

ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ² Ğ·Ğ°Ğ´Ğ°Ñ‡:

```python
class Watcher:
    async def run(self):
        while self._running:
            await sleep(self.watch_interval_seconds)
            
            # Distributed lock Ğ´Ğ»Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ğ¸
            if await self.storage.acquire_lock("global_watcher_lock", ...):
                try:
                    timed_out_job_ids = await self.storage.get_timed_out_jobs()
                    for job_id in timed_out_job_ids:
                        # ĞŸĞµÑ€ĞµĞ²Ğ¾Ğ´ Ğ² failed ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
                finally:
                    await self.storage.release_lock(...)
```

### 7. ReputationCalculator (`reputation.py`)

Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ Ñ€ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ğ¸ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ² Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸:

```python
# Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ°: ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ_Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ / Ğ²ÑĞµĞ³Ğ¾_Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 30 Ğ´Ğ½ĞµĞ¹
new_reputation = successful_tasks / total_tasks if total_tasks > 0 else 1.0
```

---

## ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### Ğ–Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Job'Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            JOB LIFECYCLE                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Client                  Engine                  Storage              Worker
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚  POST /api/v1/jobs    â”‚                       â”‚                    â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                       â”‚                    â”‚
      â”‚                       â”‚  save_job_state()     â”‚                    â”‚
      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
      â”‚                       â”‚  enqueue_job()        â”‚                    â”‚
      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
      â”‚  202 Accepted         â”‚                       â”‚                    â”‚
      â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                    â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”               â”‚                    â”‚
      â”‚               â”‚  JobExecutor  â”‚               â”‚                    â”‚
      â”‚               â”‚    (loop)     â”‚               â”‚                    â”‚
      â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                    â”‚
      â”‚                       â”‚  dequeue_job()        â”‚                    â”‚
      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
      â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚  Execute handler()    â”‚                    â”‚
      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”               â”‚                    â”‚
      â”‚                       â”‚       â”‚               â”‚                    â”‚
      â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”˜               â”‚                    â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚  [dispatch_task]      â”‚                    â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚  Dispatcher.dispatch()â”‚                    â”‚
      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”               â”‚                    â”‚
      â”‚                       â”‚       â”‚               â”‚                    â”‚
      â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”˜               â”‚                    â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚  enqueue_task()       â”‚                    â”‚
      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚                       â”‚  GET /tasks/next   â”‚
      â”‚                       â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚                       â”‚  Task payload      â”‚
      â”‚                       â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚                       â”‚      Execute       â”‚
      â”‚                       â”‚                       â”‚       task         â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚                       â”‚  POST /tasks/resultâ”‚
      â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚                       â”‚                       â”‚                    â”‚
      â”‚                       â”‚  Process result       â”‚                    â”‚
      â”‚                       â”‚  Transition to next   â”‚                    â”‚
      â”‚                       â”‚  state or finish      â”‚                    â”‚
      â”‚                       â”‚                       â”‚                    â”‚
      â–¼                       â–¼                       â–¼                    â–¼
```

### Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Job'Ğ°

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ pending â”‚
                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”‚ running â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â”‚
                      â”‚            â”‚                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
          â”‚           â”‚            â”‚           â”‚          â”‚
          â–¼           â–¼            â–¼           â–¼          â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   â”‚waiting_  â”‚ â”‚waiting_   â”‚ â”‚waiting_ â”‚ â”‚waiting_   â”‚   â”‚
   â”‚for_workerâ”‚ â”‚for_human  â”‚ â”‚for_     â”‚ â”‚for_sub_jobâ”‚   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚parallel â”‚ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚             â”‚       â”‚_tasks   â”‚       â”‚         â”‚
        â”‚             â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚         â”‚
        â”‚             â”‚            â”‚            â”‚         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                    â”‚                    â”‚
              â–¼                    â–¼                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ finished â”‚        â”‚  failed   â”‚       â”‚ quarantined â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â”‚ (manual retry)
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
```

---

## API Ğ¸ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ»Ñ‹ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ

### Public API (Ğ±ĞµĞ· Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸)

| Endpoint | Method | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|----------|--------|----------|
| `/_public/status` | GET | Health check |
| `/_public/metrics` | GET | Prometheus Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ |
| `/_public/docs` | GET | API Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ |
| `/_public/webhooks/approval/{job_id}` | POST | Human approval webhook |
| `/_public/jobs/quarantined` | GET | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº job'Ğ¾Ğ² Ğ² ĞºĞ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ğ½Ğµ |
| `/_public/debug/flush_db` | POST | ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ‘Ğ” (dev) |

### Client API (X-Avtomatika-Token)

| Endpoint | Method | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|----------|--------|----------|
| `/api/{version}/{endpoint}` | POST | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ job'Ğ° |
| `/api/{version}/jobs/{job_id}` | GET | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ job'Ğ° |
| `/api/{version}/jobs/{job_id}/cancel` | POST | ĞÑ‚Ğ¼ĞµĞ½Ğ° job'Ğ° |
| `/api/{version}/jobs/{job_id}/history` | GET | Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ job'Ğ° |
| `/api/{version}/jobs` | GET | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº job'Ğ¾Ğ² (Ñ Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸ĞµĞ¹) |
| `/api/{version}/workers` | GET | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ² |
| `/api/{version}/dashboard` | GET | Dashboard Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ |
| `/api/{version}/blueprints/{name}/graph` | GET | Ğ“Ñ€Ğ°Ñ„ blueprint'Ğ° |
| `/api/{version}/admin/reload-workers` | POST | ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ¾Ğ² |

### Worker API (X-Worker-Token)

| Endpoint | Method | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|----------|--------|----------|
| `/_worker/workers/register` | POST | Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ° |
| `/_worker/workers/{worker_id}` | PATCH | Heartbeat/update |
| `/_worker/workers/{worker_id}/tasks/next` | GET | ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ (long poll) |
| `/_worker/tasks/result` | POST | ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ° |
| `/_worker/ws/{worker_id}` | WS | WebSocket ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ |

### Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Job State

```json
{
  "id": "uuid",
  "blueprint_name": "my_blueprint",
  "current_state": "processing",
  "initial_data": { "input": "..." },
  "state_history": { "step1_result": "..." },
  "status": "running",
  "tracing_context": { "traceparent": "..." },
  "client_config": { "token": "...", "plan": "..." },
  "retry_count": 0,
  "current_task_id": "uuid",
  "task_worker_id": "worker-1",
  "current_task_info": { "type": "...", "params": {} },
  "current_task_transitions": { "success": "next_state" }
}
```

### Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Task Payload

```json
{
  "job_id": "uuid",
  "task_id": "uuid",
  "type": "video_transcoding",
  "params": { "input_path": "/path/to/file" },
  "tracing_context": { "traceparent": "..." }
}
```

### Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Task Result

```json
{
  "job_id": "uuid",
  "task_id": "uuid",
  "worker_id": "worker-1",
  "result": {
    "status": "success",
    "data": { "output_path": "/path/to/result" }
  }
}
```

### ĞšĞ¾Ğ´Ñ‹ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

```json
{
  "status": "failure",
  "error": {
    "code": "TRANSIENT_ERROR | PERMANENT_ERROR | INVALID_INPUT_ERROR",
    "message": "Error description"
  }
}
```

| ĞšĞ¾Ğ´ | ĞŸĞ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ |
|-----|-----------|
| `TRANSIENT_ERROR` | ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ retry (Ğ´Ğ¾ JOB_MAX_RETRIES) |
| `PERMANENT_ERROR` | ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ² quarantine |
| `INVALID_INPUT_ERROR` | ĞĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğ² failed |

---

## Ğ¥Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### StorageBackend (State Storage)

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ¥Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ job'Ğ¾Ğ², Ğ¾Ñ‡ĞµÑ€ĞµĞ´ĞµĞ¹, Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°Ñ….

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**
- `MemoryStorage` â€” Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ²
- `RedisStorage` â€” Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°

**ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:**

```python
# Job State
async def get_job_state(job_id) -> Optional[Dict]
async def save_job_state(job_id, state)
async def update_job_state(job_id, update_data) -> Dict

# Job Queue
async def enqueue_job(job_id)
async def dequeue_job() -> Optional[str]  # Blocking

# Task Queue (per worker)
async def enqueue_task_for_worker(worker_id, payload, priority)
async def dequeue_task_for_worker(worker_id, timeout) -> Optional[Dict]

# Workers
async def register_worker(worker_id, worker_info, ttl)
async def update_worker_status(worker_id, status_update, ttl)
async def get_available_workers() -> List[Dict]

# Timeout Tracking
async def add_job_to_watch(job_id, timeout_at)
async def get_timed_out_jobs() -> List[str]

# Distributed Locks
async def acquire_lock(key, holder_id, ttl) -> bool
async def release_lock(key, holder_id) -> bool
```

**Redis Key Schema:**

| Pattern | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|---------|------------|
| `orchestrator:job:{job_id}` | Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ job'Ğ° |
| `orchestrator:job_queue` | ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ job'Ğ¾Ğ² (LIST) |
| `orchestrator:quarantine_queue` | ĞšĞ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ğ½ (LIST) |
| `orchestrator:watched_jobs` | ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ğ¾Ğ² (SORTED SET) |
| `orchestrator:worker:info:{worker_id}` | Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğµ |
| `orchestrator:worker:token:{worker_id}` | Ğ¢Ğ¾ĞºĞµĞ½ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ° |
| `orchestrator:task_queue:{worker_id}` | ĞÑ‡ĞµÑ€ĞµĞ´ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ° (SORTED SET) |
| `orchestrator:client_config:{token}` | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° (HASH) |
| `orchestrator:quota:{token}` | ĞšĞ²Ğ¾Ñ‚Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° |
| `orchestrator:lock:{key}` | Distributed lock |
| `orchestrator:task_cancel:{task_id}` | Ğ¤Ğ»Ğ°Ğ³ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ |

### HistoryStorage (Audit/Analytics)

**ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ:** Ğ”Ğ¾Ğ»Ğ³Ğ¾ÑÑ€Ğ¾Ñ‡Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸ Ğ¸ Ğ°ÑƒĞ´Ğ¸Ñ‚Ğ°.

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**
- `NoOpHistoryStorage` â€” Ğ·Ğ°Ğ³Ğ»ÑƒÑˆĞºĞ°
- `SQLiteHistoryStorage` â€” Ğ´Ğ»Ñ Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… deployment'Ğ¾Ğ²
- `PostgresHistoryStorage` â€” Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°

**Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹:**

```sql
-- Job Events
CREATE TABLE job_events (
    id SERIAL PRIMARY KEY,
    job_id VARCHAR(255),
    state VARCHAR(255),
    event_type VARCHAR(50),
    duration_ms INTEGER,
    attempt_number INTEGER,
    context_snapshot JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Worker Events
CREATE TABLE worker_events (
    id SERIAL PRIMARY KEY,
    worker_id VARCHAR(255),
    event_type VARCHAR(50),
    worker_info_snapshot JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Ğ¢Ğ¸Ğ¿Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Job:**
- `state_started` â€” Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
- `state_finished` â€” Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
- `state_failed` â€” Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞµ
- `task_dispatched` â€” Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñƒ
- `task_finished` â€” Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°
- `sub_blueprint_started` â€” Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾Ğ´-Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°

**Ğ¢Ğ¸Ğ¿Ñ‹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Worker:**
- `registered` â€” Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
- `status_update` â€” heartbeat Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸

---

## ĞÑ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ Ğ¸ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Load Balancer  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                      â”‚                      â”‚
          â–¼                      â–¼                      â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Orchestratorâ”‚        â”‚ Orchestratorâ”‚        â”‚ Orchestratorâ”‚
   â”‚  Instance 1 â”‚        â”‚  Instance 2 â”‚        â”‚  Instance 3 â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚     Redis     â”‚
                         â”‚   (Shared)    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹:**
1. **Stateless API** â€” Ğ²ÑÑ‘ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ² Redis
2. **Distributed Locks** â€” ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ñ„Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²
3. **Redis TTL** â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ñ‘ĞºÑˆĞ¸Ñ… Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²

### Retry Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RETRY FLOW                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Task fails with TRANSIENT_ERROR
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ retry_count < MAX?  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
     Yes    â”‚    No
     â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
     â”‚             â”‚
     â–¼             â–¼
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚ Retry â”‚   â”‚ Quarantine â”‚
 â”‚ Task  â”‚   â”‚   Job      â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Timeout Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

```python
# ĞŸÑ€Ğ¸ dispatch Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
timeout_at = now + timeout_seconds
await storage.add_job_to_watch(job_id, timeout_at)

# Watcher Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚
timed_out = await storage.get_timed_out_jobs()  # ZRANGEBYSCORE + ZREM
for job_id in timed_out:
    job_state["status"] = "failed"
```

### Cancellation Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼

1. **Redis Flag** â€” `SET orchestrator:task_cancel:{task_id} 1 EX 3600`
2. **WebSocket** â€” Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñƒ (ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ)
3. **Worker polling** â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ğ»Ğ°Ğ³Ğ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸

---

## Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ

### ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  AUTHENTICATION FLOW                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  CLIENT REQUEST                    WORKER REQUEST
       â”‚                                 â”‚
       â”‚ X-Avtomatika-Token              â”‚ X-Worker-Token
       â–¼                                 â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ client_auth_    â”‚            â”‚ worker_auth_    â”‚
  â”‚ middleware      â”‚            â”‚ middleware      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                              â”‚
           â–¼                              â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Redis lookup:   â”‚            â”‚ 1. Individual   â”‚
  â”‚ client_config:  â”‚            â”‚    token check  â”‚
  â”‚ {token}         â”‚            â”‚    (SHA256)     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ 2. Global token â”‚
           â”‚                     â”‚    fallback     â”‚
           â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â–¼                              â–¼
    request["client_config"]       request["worker_id"]
```

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

**clients.toml:**
```toml
[clients.production]
token = "secret-client-token"
plan = "premium"
daily_quota = 10000

[clients.production.params]
max_file_size = 1073741824
priority_boost = 1.5
```

**workers.toml:**
```toml
[workers.gpu-worker-1]
token = "individual-token-for-worker-1"  # Ğ¥ĞµÑˆĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ
```

### Rate Limiting

```python
# Middleware Ğ´Ğ»Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²
rate_limit_middleware_factory(storage, limit=5, period=60)

# Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Redis INCR Ñ TTL
count = await storage.increment_key_with_ttl(f"ratelimit:{identifier}", ttl=60)
if count > limit:
    return 429 Too Many Requests
```

### Quota Management

```python
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸ Ğ´ĞµĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚ ĞºĞ²Ğ¾Ñ‚Ñ‹ (Ğ°Ñ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ°Ñ Lua-Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ)
if not await storage.check_and_decrement_quota(token):
    return 429 Quota Exceeded
```

---

## Observability

### Prometheus ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸

| ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ° | Ğ¢Ğ¸Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|-----|----------|
| `orchestrator_jobs_total` | Counter | Ğ’ÑĞµĞ³Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… job'Ğ¾Ğ² |
| `orchestrator_jobs_failed_total` | Counter | Ğ’ÑĞµĞ³Ğ¾ ÑƒĞ¿Ğ°Ğ²ÑˆĞ¸Ñ… job'Ğ¾Ğ² |
| `orchestrator_job_duration_seconds` | Summary | Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ job'Ğ° |
| `orchestrator_task_queue_length` | Gauge | Ğ”Ğ»Ğ¸Ğ½Ğ° Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ Ğ·Ğ°Ğ´Ğ°Ñ‡ |
| `orchestrator_active_workers` | Gauge | ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ² |

**Endpoint:** `/_public/metrics`

### OpenTelemetry Tracing

```python
# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ span'Ğ¾Ğ²
with tracer.start_as_current_span(
    f"JobExecutor:{blueprint_name}:{state}",
    context=parent_context,
) as span:
    span.set_attribute("job.id", job_id)
    span.set_attribute("job.current_state", state)
```

**Propagation:**
- ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ñ‚Ñ€ĞµĞ¹ÑĞ¸Ğ½Ğ³Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ÑÑ Ğ² `job_state["tracing_context"]`
- ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ°Ğ¼ Ğ² `task_payload["tracing_context"]`

### Logging

```python
# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· env
LOG_LEVEL = "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_FORMAT = "json"  # "text" Ğ¸Ğ»Ğ¸ "json"
```

**JSON Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (Ğ´Ğ»Ñ production):**
```json
{
  "timestamp": "2024-01-15T10:30:00Z",
  "level": "INFO",
  "logger": "avtomatika.executor",
  "message": "Job abc123 transitioning from start to processing"
}
```

---

## Worker SDK

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Worker'Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Worker                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Registration   â”‚  â”‚   Heartbeat     â”‚  â”‚  Task       â”‚  â”‚
â”‚  â”‚  (startup)      â”‚  â”‚   Loop          â”‚  â”‚  Polling    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                   Task Handlers                          â”‚â”‚
â”‚  â”‚  @worker.task("resize_image", task_type="gpu")          â”‚â”‚
â”‚  â”‚  @worker.task("transcribe", task_type="cpu")            â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   Hot Cache     â”‚  â”‚   WebSocket     â”‚                   â”‚
â”‚  â”‚   (models)      â”‚  â”‚   (commands)    â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸

**1. Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡:**
```python
worker = Worker(
    worker_type="image-processing",
    max_concurrent_tasks=10,
    task_type_limits={
        "gpu": 1,      # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ 1 GPU-Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾
        "cpu": 4,      # Ğ”Ğ¾ 4 CPU-Ğ·Ğ°Ğ´Ğ°Ñ‡
    }
)

@worker.task("resize_image", task_type="gpu")
async def resize(params, task_id, job_id, **kwargs):
    # ... Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ...
    return {"status": "success", "data": {"path": "/output/..."}}
```

**2. Concurrency Limiting:**
- Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ (`max_concurrent_tasks`)
- Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼ Ğ·Ğ°Ğ´Ğ°Ñ‡ (`task_type_limits`)
- Ğ”Ğ¸Ğ½Ğ°Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ `supported_tasks` Ğ² heartbeat

**3. Hot Cache Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹:**
```python
@worker.task("generate_image")
async def generate(params, add_to_hot_cache, remove_from_hot_cache, **kwargs):
    model = load_model("stable_diffusion")
    add_to_hot_cache("stable_diffusion")  # Ğ¡Ğ¾Ğ¾Ğ±Ñ‰Ğ¸Ñ‚ÑŒ Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
    
    result = model.generate(params["prompt"])
    return {"status": "success", "data": {"image": result}}
```

**4. Multi-Orchestrator Mode:**
```bash
ORCHESTRATORS_CONFIG='[
  {"url": "http://orchestrator-1:8080", "weight": 100},
  {"url": "http://orchestrator-2:8080", "weight": 100}
]'
MULTI_ORCHESTRATOR_MODE=FAILOVER  # Ğ¸Ğ»Ğ¸ ROUND_ROBIN
```

**5. Progress Updates (WebSocket):**
```python
@worker.task("long_task")
async def long_task(params, task_id, job_id, send_progress, **kwargs):
    for i in range(100):
        await do_step(i)
        await send_progress(task_id, job_id, progress=i/100, message=f"Step {i}")
    return {"status": "success"}
```

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· ENV

| ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Default |
|------------|----------|---------|
| `WORKER_ID` | Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ID Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ° | **Required** |
| `ORCHESTRATOR_URL` | URL Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° | `http://localhost:8080` |
| `WORKER_TOKEN` | ĞĞ±Ñ‰Ğ¸Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ | `default-token` |
| `WORKER_INDIVIDUAL_TOKEN` | Ğ˜Ğ½Ğ´Ğ¸Ğ²Ğ¸Ğ´ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½ | â€” |
| `WORKER_ENABLE_WEBSOCKETS` | WebSocket Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° | `false` |
| `WORKER_HEARTBEAT_DEBOUNCE_DELAY` | Debounce Ğ´Ğ»Ñ heartbeat | `0.1` |
| `WORKER_PAYLOAD_DIR` | Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ´Ğ»Ñ S3 Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² | `/tmp/payloads` |

---

## Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹

### Sequence Diagram: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Job'Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚Clientâ”‚          â”‚ Engine  â”‚         â”‚Storageâ”‚        â”‚Dispatchâ”‚       â”‚Workerâ”‚
â””â”€â”€â”¬â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”¬â”€â”€â”€â”˜        â””â”€â”€â”€â”¬â”€â”€â”€â”˜        â””â”€â”€â”¬â”€â”€â”€â”˜
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚ POST /jobs/flow   â”‚                  â”‚                â”‚               â”‚
   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚ save_job_state   â”‚                â”‚               â”‚
   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚ enqueue_job      â”‚                â”‚               â”‚
   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚ 202 {job_id}      â”‚                  â”‚                â”‚               â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚               â”‚
   â”‚                   â”‚      â”‚    JobExecutor Loop   â”‚    â”‚               â”‚
   â”‚                   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚ dequeue_job()    â”‚                â”‚               â”‚
   â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚ get_job_state    â”‚                â”‚               â”‚
   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚ Execute handler  â”‚                â”‚               â”‚
   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”          â”‚                â”‚               â”‚
   â”‚                   â”‚       â”‚          â”‚                â”‚               â”‚
   â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”˜ actions.dispatch_task()   â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚  dispatch()    â”‚               â”‚
   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚ enqueue_task  â”‚
   â”‚                   â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚ update status    â”‚                â”‚               â”‚
   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚  GET /tasks   â”‚
   â”‚                   â”‚                  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚   task_payload â”‚               â”‚
   â”‚                   â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚    Execute    â”‚
   â”‚                   â”‚                  â”‚                â”‚     task      â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚ POST /result  â”‚
   â”‚                   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â”‚                   â”‚ Process result   â”‚                â”‚               â”‚
   â”‚                   â”‚ Transition state â”‚                â”‚               â”‚
   â”‚                   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚               â”‚
   â”‚                   â”‚                  â”‚                â”‚               â”‚
   â–¼                   â–¼                  â–¼                â–¼               â–¼
```

### Class Diagram: ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              OrchestratorEngine                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - storage: StorageBackend                                                    â”‚
â”‚ - config: Config                                                             â”‚
â”‚ - blueprints: Dict[str, StateMachineBlueprint]                              â”‚
â”‚ - history_storage: HistoryStorageBase                                        â”‚
â”‚ - ws_manager: WebSocketManager                                               â”‚
â”‚ - dispatcher: Dispatcher                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + register_blueprint(blueprint)                                              â”‚
â”‚ + setup()                                                                    â”‚
â”‚ + run() / start() / stop()                                                   â”‚
â”‚ - _create_job_handler(blueprint)                                             â”‚
â”‚ - _task_result_handler(request)                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ uses
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       StateMachineBlueprint         â”‚    â”‚           Dispatcher             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - name: str                         â”‚    â”‚ - storage: StorageBackend        â”‚
â”‚ - handlers: Dict[str, Callable]     â”‚    â”‚ - config: Config                 â”‚
â”‚ - aggregator_handlers: Dict         â”‚    â”‚ - _round_robin_indices: Dict     â”‚
â”‚ - conditional_handlers: List        â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - start_state: str                  â”‚    â”‚ + dispatch(job_state, task_info) â”‚
â”‚ - end_states: Set[str]              â”‚    â”‚ - _select_default()              â”‚
â”‚ - data_stores: Dict                 â”‚    â”‚ - _select_round_robin()          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚ - _select_least_connections()    â”‚
â”‚ + handler_for(state).when(cond)     â”‚    â”‚ - _select_cheapest()             â”‚
â”‚ + aggregator_for(state)             â”‚    â”‚ - _select_best_value()           â”‚
â”‚ + find_handler(state, context)      â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ + render_graph()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ creates
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            JobContext               â”‚    â”‚         ActionFactory            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + job_id: str                       â”‚    â”‚ - _job_id: str                   â”‚
â”‚ + current_state: str                â”‚    â”‚ - _next_state_val: str           â”‚
â”‚ + initial_data: Dict                â”‚    â”‚ - _task_to_dispatch_val: Dict    â”‚
â”‚ + state_history: Dict               â”‚    â”‚ - _parallel_tasks_val: Dict      â”‚
â”‚ + client: ClientConfig              â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + actions: ActionFactory            â”‚    â”‚ + transition_to(state)           â”‚
â”‚ + data_stores: SimpleNamespace      â”‚    â”‚ + dispatch_task(...)             â”‚
â”‚ + tracing_context: Dict             â”‚    â”‚ + dispatch_parallel(...)         â”‚
â”‚ + aggregation_results: Dict         â”‚    â”‚ + await_human_approval(...)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ + run_blueprint(...)             â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### State Diagram: Worker Status

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Unregistered   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ POST /workers/register
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”‚       Idle       â”‚â—„â”€â”€â”€â”€â”€â”€â”
           â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
           â”‚                â”‚                 â”‚
           â”‚  No tasks      â”‚  Task received  â”‚  Task completed
           â”‚  available     â”‚                 â”‚
           â”‚                â–¼                 â”‚
           â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
           â”‚       â”‚      Busy        â”‚â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                â”‚
           â”‚                â”‚ All type limits reached
           â”‚                â–¼
           â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â””â”€â”€â”€â”€â”€â”€â–ºâ”‚  Fully Busy     â”‚
                   â”‚ (no supported   â”‚
                   â”‚  tasks)         â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ TTL expires (no heartbeat)
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Expired       â”‚
                    â”‚ (auto-removed)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€

```python
import asyncio
from avtomatika import OrchestratorEngine, StateMachineBlueprint
from avtomatika.storage import MemoryStorage
from avtomatika.config import Config

storage = MemoryStorage()
config = Config()

# Blueprint
bp = StateMachineBlueprint("hello", api_endpoint="/jobs/hello", api_version="v1")

@bp.handler_for("start", is_start=True)
async def start(job_id, initial_data, actions):
    print(f"Job {job_id}: Hello, {initial_data.get('name')}!")
    actions.transition_to("end")

@bp.handler_for("end", is_end=True)
async def end(job_id, actions):
    print(f"Job {job_id}: Done!")

# Engine
engine = OrchestratorEngine(storage, config)
engine.register_blueprint(bp)

async def main():
    await engine.start()
    await asyncio.Event().wait()

asyncio.run(main())
```

### Blueprint Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ¼

```python
# Blueprint
@bp.handler_for("process", is_start=True)
async def process(initial_data, actions):
    actions.dispatch_task(
        task_type="image_resize",
        params={"path": initial_data["image_path"], "size": 800},
        transitions={"success": "notify", "failure": "error"}
    )

@bp.handler_for("notify")
async def notify(state_history, actions):
    print(f"Resized image: {state_history['resized_path']}")
    actions.transition_to("done")

@bp.handler_for("done", is_end=True)
async def done(actions):
    pass

@bp.handler_for("error", is_end=True)
async def error(state_history, actions):
    print(f"Error: {state_history.get('error_message')}")
```

```python
# Worker
from avtomatika_worker import Worker

worker = Worker(worker_type="image-processor")

@worker.task("image_resize")
async def resize(params, **kwargs):
    # ... resize logic ...
    return {
        "status": "success",
        "data": {"resized_path": f"/output/{params['path']}"}
    }

worker.run()
```

### ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ (Fan-out/Fan-in)

```python
@bp.handler_for("parallel_start", is_start=True)
async def fan_out(initial_data, actions):
    tasks = [
        {"task_type": "analyze", "params": {"file": f}}
        for f in initial_data["files"]
    ]
    actions.dispatch_parallel(tasks, aggregate_into="aggregate")

@bp.aggregator_for("aggregate")
async def fan_in(aggregation_results, state_history, actions):
    # aggregation_results = {task_id: result_dict, ...}
    total = sum(r.get("data", {}).get("score", 0) for r in aggregation_results.values())
    state_history["total_score"] = total
    actions.transition_to("done")

@bp.handler_for("done", is_end=True)
async def done(state_history, actions):
    print(f"Total score: {state_history['total_score']}")
```

---

## Ğ ĞµĞ·ÑĞ¼Ğµ

**Avtomatika** â€” ÑÑ‚Ğ¾ production-ready Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ´Ğ»Ñ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ñ… workflow'Ğ¾Ğ² Ñ:

âœ… **State Machine Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´** â€” Ñ‡Ñ‘Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²  
âœ… **PULL-Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ** â€” Ğ²Ğ¾Ñ€ĞºĞµÑ€Ñ‹ ÑĞ°Ğ¼Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ÑÑ‚ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸  
âœ… **Ğ“Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ** â€” stateless Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°  
âœ… **ĞÑ‚ĞºĞ°Ğ·Ğ¾ÑƒÑÑ‚Ğ¾Ğ¹Ñ‡Ğ¸Ğ²Ğ¾ÑÑ‚ÑŒ** â€” retry, quarantine, timeout monitoring  
âœ… **Flexible routing** â€” 5 ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¹ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡  
âœ… **Dependency Injection** â€” Ñ‡Ğ¸ÑÑ‚Ñ‹Ğµ Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸  
âœ… **Full Observability** â€” Prometheus, OpenTelemetry, structured logging  
âœ… **Security** â€” Ñ‚Ğ¾ĞºĞµĞ½Ñ‹, rate limiting, quotas  
âœ… **Worker SDK** â€” Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ SDK Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ²Ğ¾Ñ€ĞºĞµÑ€Ğ¾Ğ²  
